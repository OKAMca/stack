# ADR 003: Generated Code and ESLint Policy

## Status

Implemented

## Context

The @okam/stack monorepo uses code generation tools to produce TypeScript types and GraphQL client code. These generated
files should not be linted because:

1. They are overwritten on each codegen run
2. They may contain patterns that trigger lint rules but are intentional for the generator
3. Manual edits to generated files will be lost

ESLint configuration must explicitly ignore generated paths to prevent false positives and wasted CI time.

## Decision

### Generated Code Locations

All GraphQL code generation uses `@graphql-codegen/cli` with the client preset. The following paths contain generated
code and are excluded from linting:

| Path | Generator Config | Tool |
|------|------------------|------|
| `apps/directus-data-query/src/lib/gql/generated/` | `codegen.ts` (root) | @graphql-codegen/cli |
| `libs/directus/directus-block/src/generated/` | Similar pattern | @graphql-codegen/cli |
| `libs/directus/directus-query/src/lib/gql/admin/generated/` | `libs/directus/directus-query/codegen-admin.ts` | @graphql-codegen/cli |

### How to Run Code Generation

```bash
# Generate GraphQL types for directus-data-query (uses codegen.ts at root)
npm run codegen

# Generate GraphQL admin types for directus-query (uses libs/directus/directus-query/codegen-admin.ts)
npx graphql-codegen --config libs/directus/directus-query/codegen-admin.ts
```

**Required environment variables:**

| Config | Required Variables |
|--------|-------------------|
| `codegen.ts` | `NEXT_PUBLIC_GRAPHQL_URL`, `NEXT_PUBLIC_API_TOKEN` |
| `codegen-admin.ts` | `NEXT_GRAPHQL_URL_ADMIN`, `NEXT_API_TOKEN_ADMIN` |

### ESLint Configuration

Generated paths are explicitly listed in `eslint.config.js` ignores (not using broad `**/generated/**` patterns) to:

1. Make the scope of ignored files explicit and auditable
2. Prevent accidental exclusion of authored files in `generated/` directories
3. Allow new generated directories to require explicit addition (conscious decision)

### Clarifications

**`apps/demo/index.d.ts`**: This is NOT generated code. It's a manually authored TypeScript module declaration for SVG
imports. It is linted with relaxed rules via the `declaration-files` config block in `eslint.config.js`.

**Declaration files (`.d.ts`) linting policy**:

1. **Authored `.d.ts` files ARE linted** with relaxed rules via the `declaration-files` config block:
   - `ts/no-explicit-any`: off (module augmentation often needs any)
   - Type-aware rules: off (no runtime code)
   - Examples: `apps/demo/index.d.ts`, `libs/automation/*/schema.d.ts`, `libs/directus/directus-flexible-content/tiptap.d.ts`

2. **Type-aware parsing is disabled** for all `.d.ts` via `ignoresTypeAware: ['**/*.d.ts']`

3. **Only truly generated `.d.ts` files are fully ignored**:
   - `**/next-env.d.ts` (auto-generated by Next.js, says "should not be edited")
   - `**/.next/**/*.d.ts` (Next.js development output)
   - Build output in `dist/` directories (already excluded via `**/dist/**`)

## Consequences

### Positive

- Generated files don't pollute lint output
- Explicit paths are auditable and intentional
- New generators require explicit ESLint configuration

### Negative

- New codegen outputs must be manually added to eslint ignores
- Path changes in codegen configs require matching ESLint updates

### Mitigation

When adding new code generation:
1. Update the generator's output path in its config
2. Add the corresponding path to `eslint.config.js` ignores
3. Update this ADR with the new generator details
