{
  "project": "@okam/ai CLI Package",
  "goal": "Create publishable CLI for AI automation tools, runnable via npx @okam/ai",
  "statuses": ["pending", "in_progress", "completed", "blocked"],
  "tasks": [
    {
      "id": "1",
      "title": "Generate library scaffolding",
      "description": "Run: npx nx g @nx/js:library libs/ai --publishable --importPath=@okam/ai --bundler=esbuild --unitTestRunner=vitest --linter=eslint",
      "status": "completed",
      "notes": "Generated with NX generator. Fixed tsconfig.json module setting (commonjs -> ESNext) for ESM compatibility. Removed library-specific eslint.config.mjs to use root @antfu/eslint-config. Verified build, lint, and test all pass."
    },
    {
      "id": "2",
      "title": "Install commander dependency",
      "description": "Run: npm i commander",
      "status": "completed",
      "notes": "Installed commander@14.0.2. Verified build, lint, and test all still pass."
    },
    {
      "id": "3",
      "title": "Create CLI entry point",
      "description": "Create libs/ai/src/cli.ts with commander setup, imports for ralph/init/archive commands, and program.parse()",
      "status": "completed",
      "notes": "Created cli.ts with commander setup. Command imports are commented out until commands are implemented. Added commander to libs/ai/package.json dependencies. Build, lint, and tests all pass."
    },
    {
      "id": "4",
      "title": "Create init command",
      "description": "Create libs/ai/src/commands/init.ts - creates prd.json template and progress.txt, errors if file exists",
      "status": "completed",
      "notes": "Created init command with prd.json and progress.txt templates. Supports --force flag to overwrite. Uses process.stdout.write for CLI output (linter disallows console.log). Registered in cli.ts. Build, lint, and tests all pass."
    },
    {
      "id": "5",
      "title": "Create archive command",
      "description": "Create libs/ai/src/commands/archive.ts - moves prd.json and progress.txt to archive/ with timestamp",
      "status": "completed",
      "notes": "Created archive command that moves prd.json and progress.txt to archive/ folder. Files are renamed with pattern: {type}_{project-slug}_{date}.{ext}. Creates archive/ directory if needed. Registered in cli.ts. Build, lint, and tests all pass."
    },
    {
      "id": "6",
      "title": "Create ralph command",
      "description": "Create libs/ai/src/commands/ralph.ts - loads config, checks PRD exists, spawns ralph.sh with env vars",
      "status": "completed",
      "notes": "Created ralph.ts with commander setup. Supports options: --model (default: claude-sonnet-4-20250514), --context (additional context path), --prd (prd.json path), --progress (progress.txt path). Validates PRD exists before spawning ralph.sh. Sets RALPH_MODEL, RALPH_CONTEXT, RALPH_PRD, RALPH_PROGRESS env vars. Registered in cli.ts. Build, lint, and tests all pass."
    },
    {
      "id": "7",
      "title": "Create portable ralph.sh script",
      "description": "Create libs/ai/scripts/ralph.sh - reads config from env vars (RALPH_MODEL, RALPH_CONTEXT, RALPH_PRD, RALPH_PROGRESS)",
      "status": "completed",
      "notes": "Created libs/ai/scripts/prd-agent.sh (renamed from ralph.sh to avoid .gitignore conflict). Script reads RALPH_MODEL, RALPH_CONTEXT, RALPH_PRD, RALPH_PROGRESS env vars. Builds dynamic Claude prompt with context path and PRD references. Supports iteration loop with failure detection. Updated ralph.ts to spawn prd-agent.sh. Configured project.json to copy scripts/ to dist. Build, lint, and tests all pass."
    },
    {
      "id": "8",
      "title": "Configure project.json build",
      "description": "Update libs/ai/project.json - esbuild executor, platform node, format esm, bundle true, assets for scripts/",
      "status": "completed",
      "notes": "Updated project.json: changed format from cjs to esm, added additionalEntryPoints for cli.ts. Build now outputs index.js and cli.js in ESM format. Completed as part of Task 9 since package.json config required matching build output."
    },
    {
      "id": "9",
      "title": "Configure package.json",
      "description": "Update libs/ai/package.json - add bin field, type module, publishConfig, engines node >=20",
      "status": "completed",
      "notes": "Configured package.json with: type=module, bin field pointing to ./cli.js, exports for ESM, main/types, engines node>=20, publishConfig access=public, license BUSL-1.1, repository URL. Also updated project.json to build ESM format with CLI entry point. CLI --help verified working."
    },
    {
      "id": "10",
      "title": "Add unit tests for init command",
      "description": "Create libs/ai/src/commands/init.spec.ts - test file creation, error on existing file",
      "status": "completed",
      "notes": "Created 8 unit tests covering: file creation, prd.json structure validation, progress.txt header, error on existing files (single and both), --force flag override, success message output. All tests pass. Lint passes."
    },
    {
      "id": "11",
      "title": "Add unit tests for archive command",
      "description": "Create libs/ai/src/commands/archive.spec.ts - test file move, timestamp format, error handling",
      "status": "completed",
      "notes": "Created 13 unit tests covering: error when prd.json missing, archiving both files, archive directory creation, existing archive directory handling, skip missing progress.txt, slugify project name, truncate long project names, default slug for missing/empty project field, invalid JSON handling, ISO date format, file content preservation, success messages. All tests pass. Lint passes."
    },
    {
      "id": "12",
      "title": "Add to nx.json release config",
      "description": "Add ai to release.projects array in nx.json",
      "status": "completed",
      "notes": "Already present in nx.json release.projects array (was added during initial scaffolding in Task 1)."
    },
    {
      "id": "13",
      "title": "Build and verify",
      "description": "Run npx nx build ai, verify dist/libs/ai/cli.js --help works, scripts/ folder present",
      "status": "completed",
      "notes": "Build successful. Verified: cli.js --help displays all commands (init, archive, ralph). scripts/prd-agent.sh present in dist. Lint passes. 22 tests pass."
    },
    {
      "id": "14",
      "description": "Update prd.json init template to include config section with agent, context, verification fields",
      "status": "completed",
      "steps": [
        "Add config object to PRD_TEMPLATE in init.ts",
        "Include: agent (default: claude), context (empty), verification (default wording)",
        "Update init.spec.ts tests to verify config section"
      ],
      "notes": "Added config object to PRD_TEMPLATE with agent='claude', context='', verification='Run your tests and type checks.' Updated init.spec.ts to verify config section. Build, lint, and 22 tests all pass."
    },
    {
      "id": "15",
      "description": "Update ralph.ts to read config from prd.json and support CLI flag overrides",
      "status": "completed",
      "steps": [
        "Add CLI flags: -a/--agent, -c/--context, -v/--verification",
        "Read prd.json config section",
        "Resolution order: CLI flags > prd.json config > defaults",
        "Remove --model flag, replace with --agent",
        "Pass resolved values to prd-agent.sh via ENV vars (internal)"
      ],
      "notes": "Updated ralph.ts: Added readPrdConfig() to read config from prd.json. Replaced -m/--model with -a/--agent. Added -v/--verification flag. Resolution order: CLI flags > prd.json config > defaults. Env vars changed: RALPH_MODEL -> RALPH_AGENT, added RALPH_VERIFICATION. Build, lint, and 22 tests all pass."
    },
    {
      "id": "16",
      "description": "Update prd-agent.sh to use RALPH_AGENT env var and support codex CLI",
      "status": "completed",
      "steps": [
        "Rename RALPH_MODEL to RALPH_AGENT",
        "Add RALPH_CONTEXT and RALPH_VERIFICATION env vars",
        "Update PROMPT to use context and verification from env vars",
        "Add conditional for claude vs codex CLI invocation"
      ],
      "notes": "Updated prd-agent.sh: Renamed RALPH_MODEL to RALPH_AGENT. Added RALPH_VERIFICATION env var. Updated PROMPT to use verification from env var. Added run_claude() and run_codex() functions with conditional invocation based on AGENT value. Codex uses --full-auto and --model o3. Added extract_result() function with agent-specific jq filters. Build, lint, and 22 tests all pass."
    },
    {
      "id": "17",
      "description": "Filter completion signal detection to exclude thinking/reasoning output",
      "status": "pending",
      "steps": [
        "For Claude: filter to only text content, exclude thinking blocks",
        "For Codex: filter to only agent_message items, exclude reasoning items",
        "Claude jq: select(.type == 'text').text (not thinking)",
        "Codex jq: select(.item.type == 'agent_message').item.text (not reasoning)",
        "Check <promise>COMPLETE</promise> only in filtered output",
        "Test with both CLIs to verify no false positives from thinking"
      ]
    },
    {
      "id": "18",
      "description": "Build and verify new config system works",
      "status": "pending",
      "steps": [
        "npx nx build ai",
        "npx nx test ai",
        "npx nx lint ai",
        "Test: node dist/libs/ai/cli.js ralph --help (verify new flags shown)",
        "Test: node dist/libs/ai/cli.js init in /tmp (verify config section created)",
        "DO NOT run ralph in this project - would loop on same tasks"
      ]
    }
  ]
}
