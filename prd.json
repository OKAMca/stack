{
  "project": "@okam/ai CLI Package",
  "goal": "Create publishable CLI for AI automation tools, runnable via npx @okam/ai",
  "statuses": ["pending", "in_progress", "completed", "blocked"],
  "tasks": [
    {
      "id": "1",
      "title": "Generate library scaffolding",
      "description": "Run: npx nx g @nx/js:library libs/ai --publishable --importPath=@okam/ai --bundler=esbuild --unitTestRunner=vitest --linter=eslint",
      "status": "completed",
      "notes": "Generated with NX generator. Fixed tsconfig.json module setting (commonjs -> ESNext) for ESM compatibility. Removed library-specific eslint.config.mjs to use root @antfu/eslint-config. Verified build, lint, and test all pass."
    },
    {
      "id": "2",
      "title": "Install commander dependency",
      "description": "Run: npm i commander",
      "status": "completed",
      "notes": "Installed commander@14.0.2. Verified build, lint, and test all still pass."
    },
    {
      "id": "3",
      "title": "Create CLI entry point",
      "description": "Create libs/ai/src/cli.ts with commander setup, imports for ralph/init/archive commands, and program.parse()",
      "status": "completed",
      "notes": "Created cli.ts with commander setup. Command imports are commented out until commands are implemented. Added commander to libs/ai/package.json dependencies. Build, lint, and tests all pass."
    },
    {
      "id": "4",
      "title": "Create init command",
      "description": "Create libs/ai/src/commands/init.ts - creates prd.json template and progress.txt, errors if file exists",
      "status": "completed",
      "notes": "Created init command with prd.json and progress.txt templates. Supports --force flag to overwrite. Uses process.stdout.write for CLI output (linter disallows console.log). Registered in cli.ts. Build, lint, and tests all pass."
    },
    {
      "id": "5",
      "title": "Create archive command",
      "description": "Create libs/ai/src/commands/archive.ts - moves prd.json and progress.txt to archive/ with timestamp",
      "status": "completed",
      "notes": "Created archive command that moves prd.json and progress.txt to archive/ folder. Files are renamed with pattern: {type}_{project-slug}_{date}.{ext}. Creates archive/ directory if needed. Registered in cli.ts. Build, lint, and tests all pass."
    },
    {
      "id": "6",
      "title": "Create ralph command",
      "description": "Create libs/ai/src/commands/ralph.ts - loads config, checks PRD exists, spawns ralph.sh with env vars",
      "status": "completed",
      "notes": "Created ralph.ts with commander setup. Supports options: --model (default: claude-sonnet-4-20250514), --context (additional context path), --prd (prd.json path), --progress (progress.txt path). Validates PRD exists before spawning ralph.sh. Sets RALPH_MODEL, RALPH_CONTEXT, RALPH_PRD, RALPH_PROGRESS env vars. Registered in cli.ts. Build, lint, and tests all pass."
    },
    {
      "id": "7",
      "title": "Create portable ralph.sh script",
      "description": "Create libs/ai/scripts/ralph.sh - reads config from env vars (RALPH_MODEL, RALPH_CONTEXT, RALPH_PRD, RALPH_PROGRESS)",
      "status": "completed",
      "notes": "Created libs/ai/scripts/prd-agent.sh (renamed from ralph.sh to avoid .gitignore conflict). Script reads RALPH_MODEL, RALPH_CONTEXT, RALPH_PRD, RALPH_PROGRESS env vars. Builds dynamic Claude prompt with context path and PRD references. Supports iteration loop with failure detection. Updated ralph.ts to spawn prd-agent.sh. Configured project.json to copy scripts/ to dist. Build, lint, and tests all pass."
    },
    {
      "id": "8",
      "title": "Configure project.json build",
      "description": "Update libs/ai/project.json - esbuild executor, platform node, format esm, bundle true, assets for scripts/",
      "status": "completed",
      "notes": "Updated project.json: changed format from cjs to esm, added additionalEntryPoints for cli.ts. Build now outputs index.js and cli.js in ESM format. Completed as part of Task 9 since package.json config required matching build output."
    },
    {
      "id": "9",
      "title": "Configure package.json",
      "description": "Update libs/ai/package.json - add bin field, type module, publishConfig, engines node >=20",
      "status": "completed",
      "notes": "Configured package.json with: type=module, bin field pointing to ./cli.js, exports for ESM, main/types, engines node>=20, publishConfig access=public, license BUSL-1.1, repository URL. Also updated project.json to build ESM format with CLI entry point. CLI --help verified working."
    },
    {
      "id": "10",
      "title": "Add unit tests for init command",
      "description": "Create libs/ai/src/commands/init.spec.ts - test file creation, error on existing file",
      "status": "completed",
      "notes": "Created 8 unit tests covering: file creation, prd.json structure validation, progress.txt header, error on existing files (single and both), --force flag override, success message output. All tests pass. Lint passes."
    },
    {
      "id": "11",
      "title": "Add unit tests for archive command",
      "description": "Create libs/ai/src/commands/archive.spec.ts - test file move, timestamp format, error handling",
      "status": "completed",
      "notes": "Created 13 unit tests covering: error when prd.json missing, archiving both files, archive directory creation, existing archive directory handling, skip missing progress.txt, slugify project name, truncate long project names, default slug for missing/empty project field, invalid JSON handling, ISO date format, file content preservation, success messages. All tests pass. Lint passes."
    },
    {
      "id": "12",
      "title": "Add to nx.json release config",
      "description": "Add ai to release.projects array in nx.json",
      "status": "completed",
      "notes": "Already present in nx.json release.projects array (was added during initial scaffolding in Task 1)."
    },
    {
      "id": "13",
      "title": "Build and verify",
      "description": "Run npx nx build ai, verify dist/libs/ai/cli.js --help works, scripts/ folder present",
      "status": "completed",
      "notes": "Build successful. Verified: cli.js --help displays all commands (init, archive, ralph). scripts/prd-agent.sh present in dist. Lint passes. 22 tests pass."
    },
    {
      "id": "14",
      "description": "Update prd.json init template to include config section with agent, context, verification fields",
      "status": "completed",
      "steps": [
        "Add config object to PRD_TEMPLATE in init.ts",
        "Include: agent (default: claude), context (empty), verification (default wording)",
        "Update init.spec.ts tests to verify config section"
      ],
      "notes": "Added config object to PRD_TEMPLATE with agent='claude', context='', verification='Run your tests and type checks.' Updated init.spec.ts to verify config section. Build, lint, and 22 tests all pass."
    },
    {
      "id": "15",
      "description": "Update ralph.ts to read config from prd.json and support CLI flag overrides",
      "status": "completed",
      "steps": [
        "Add CLI flags: -a/--agent, -c/--context, -v/--verification",
        "Read prd.json config section",
        "Resolution order: CLI flags > prd.json config > defaults",
        "Remove --model flag, replace with --agent",
        "Pass resolved values to prd-agent.sh via ENV vars (internal)"
      ],
      "notes": "Updated ralph.ts: Added readPrdConfig() to read config from prd.json. Replaced -m/--model with -a/--agent. Added -v/--verification flag. Resolution order: CLI flags > prd.json config > defaults. Env vars changed: RALPH_MODEL -> RALPH_AGENT, added RALPH_VERIFICATION. Build, lint, and 22 tests all pass."
    },
    {
      "id": "16",
      "description": "Update prd-agent.sh to use RALPH_AGENT env var and support codex CLI",
      "status": "completed",
      "steps": [
        "Rename RALPH_MODEL to RALPH_AGENT",
        "Add RALPH_CONTEXT and RALPH_VERIFICATION env vars",
        "Update PROMPT to use context and verification from env vars",
        "Add conditional for claude vs codex CLI invocation"
      ],
      "notes": "Updated prd-agent.sh: Renamed RALPH_MODEL to RALPH_AGENT. Added RALPH_VERIFICATION env var. Updated PROMPT to use verification from env var. Added run_claude() and run_codex() functions with conditional invocation based on AGENT value. Codex uses --full-auto and --model o3. Added extract_result() function with agent-specific jq filters. Build, lint, and 22 tests all pass."
    },
    {
      "id": "17",
      "description": "Filter completion signal detection to exclude thinking/reasoning output",
      "status": "completed",
      "steps": [
        "For Claude: filter to only text content, exclude thinking blocks",
        "For Codex: filter to only agent_message items, exclude reasoning items",
        "Claude jq: select(.type == 'text').text (not thinking)",
        "Codex jq: select(.item.type == 'agent_message').item.text (not reasoning)",
        "Check <promise>COMPLETE</promise> only in filtered output",
        "Test with both CLIs to verify no false positives from thinking"
      ],
      "notes": "Updated extract_result() in prd-agent.sh. Claude: filters to assistant messages and extracts only .type=='text' content (excludes thinking blocks). Codex: filters to agent_message items and extracts text/output_text content (excludes reasoning items). Completion signal now only detected in filtered output. Build, lint, and 22 tests all pass."
    },
    {
      "id": "18",
      "description": "Fix grep -c output bug in prd-agent.sh task status counting",
      "status": "completed",
      "steps": [
        "Bug: grep -c outputs '0' with exit code 1 when no matches",
        "Current code: $(grep -c ... || echo '0') captures both '0\\n' and '0'",
        "Fix: use $(grep -c ... 2>/dev/null; true) then ${var:-0}",
        "Apply fix to pending, in_progress, and blocked counts",
        "Test output shows single line: 'Tasks: X pending, Y in progress, Z blocked'"
      ],
      "notes": "Fixed by using '|| true' instead of '|| echo 0' to suppress exit code without appending extra output. Added ${var:-0} fallback for empty results. Tested with prd.json (has tasks) and empty file (no matches) - both show clean single-line output. Build, lint, and 22 tests all pass."
    },
    {
      "id": "19",
      "description": "Build and verify new config system works",
      "status": "completed",
      "steps": [
        "npx nx build ai",
        "npx nx test ai",
        "npx nx lint ai",
        "Test: node dist/libs/ai/cli.js ralph --help (verify new flags shown)",
        "Test: node dist/libs/ai/cli.js init in /tmp (verify config section created)",
        "DO NOT run ralph in this project - would loop on same tasks"
      ],
      "notes": "All verification passed: Build successful, 22 tests pass, lint passes. CLI ralph --help shows new flags (-a/--agent, -c/--context, -v/--verification). Init command creates prd.json with config section containing agent, context, and verification fields."
    },
    {
      "id": "20",
      "description": "Fix CLI version to read from package.json instead of hardcoded '0.0.1'",
      "status": "completed",
      "steps": [
        "Import package.json in cli.ts using JSON module import",
        "Replace .version('0.0.1') with .version(pkg.version)",
        "Verify CLI --version shows correct version"
      ],
      "notes": "Used createRequire from node:module to dynamically import package.json at runtime. Path is './package.json' which resolves correctly in dist/libs/ai/ where both cli.js and package.json are located. Build, lint, and 22 tests all pass. CLI --version now shows dynamic version."
    },
    {
      "id": "21",
      "description": "Fix archive timestamp collision - add time (HH-mm-ss) to prevent same-day overwrites",
      "status": "completed",
      "steps": [
        "Update getTimestamp() to include time: YYYY-MM-DD_HH-mm-ss",
        "Update archive.spec.ts tests to match new timestamp format",
        "Test: multiple archives on same day create unique files"
      ],
      "notes": "Updated getTimestamp() to return YYYY-MM-DD_HH-mm-ss format using toTimeString().slice(0,8).replace(/:/g, '-'). Updated 4 tests to match new timestamp regex pattern. Added new test 'should create unique filenames for multiple archives on the same day' that verifies sequential archives produce unique filenames. Build, lint, and 23 tests all pass."
    },
    {
      "id": "22",
      "description": "Fix archive slugify empty string fallback when project has only symbols",
      "status": "completed",
      "steps": [
        "Check if slugify result is empty after processing",
        "Fall back to 'project' default and emit warning",
        "Add test case for project with only symbols"
      ],
      "notes": "Added check for empty slugify result in archive.ts. When project name contains only symbols (e.g., '@#$%'), slugify returns empty string. Now falls back to 'project' default and emits warning. Added test case that verifies warning message and default slug usage. Build, lint, and 24 tests all pass."
    },
    {
      "id": "23",
      "description": "Tighten iterations validation in ralph.ts to reject '1abc', '1.5'",
      "status": "completed",
      "steps": [
        "Use Number() instead of parseInt for stricter validation",
        "Check Number.isInteger() instead of Number.isNaN()",
        "Pass validated iterationCount to spawn instead of raw string"
      ],
      "notes": "Changed validation from parseInt to Number() with Number.isInteger() check. Now properly rejects '1abc' (NaN), '1.5' (not integer), '0' (less than 1), and negative numbers. Updated spawn call to pass iterationCount.toString() instead of raw string. Build, lint, and 24 tests all pass."
    },
    {
      "id": "24",
      "description": "Validate iterations as positive integer in prd-agent.sh",
      "status": "completed",
      "steps": [
        "Use regex [[ $1 =~ ^[1-9][0-9]*$ ]] for validation",
        "Update usage message to clarify positive integer required",
        "Test with 0, negative, and non-numeric inputs"
      ],
      "notes": "Added regex validation [[ $1 =~ ^[1-9][0-9]*$ ]] after empty check. Updated usage message to clarify 'positive integer (1 or greater)' requirement. Tested rejection of: 0, -5, abc, 1.5, 1abc. Build, lint, and 24 tests all pass."
    },
    {
      "id": "25",
      "description": "Update package version from 0.0.1 to 0.1.0 for initial release",
      "status": "completed",
      "steps": [
        "Update version in libs/ai/package.json to 0.1.0",
        "Verify CLI --version shows 0.1.0"
      ],
      "notes": "Updated version in libs/ai/package.json from 0.0.1 to 0.1.0. Built package and verified CLI --version shows 0.1.0. Build, lint, and 24 tests all pass."
    },
    {
      "id": "26",
      "description": "Build and verify all CodeRabbit fixes",
      "status": "completed",
      "steps": [
        "npx nx build ai",
        "npx nx test ai",
        "npx nx lint ai",
        "Test CLI --version shows 0.1.0",
        "Test archive creates unique timestamps"
      ],
      "notes": "All verification passed: Build successful, 24 tests pass, lint passes. CLI --version shows 0.1.0. Archive creates unique timestamps with format YYYY-MM-DD_HH-mm-ss (e.g., prd_project_2026-01-22_11-35-31.json)."
    }
  ]
}
