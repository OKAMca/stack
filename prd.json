{
  "project": "@okam/automation project-setup CLI",
  "goal": "Add a CLI to @okam/automation that scaffolds a production-ready Nx monorepo with Next.js, Directus, brand-ui, blocks, queries, i18n, Storybook, and ESLint — matching the patterns used across okam client projects. The generated project must build and lint from scratch without errors.",
  "statuses": [
    "pending",
    "in_progress",
    "completed",
    "blocked"
  ],
  "config": {
    "agent": "claude",
    "context": "libs/automation",
    "verification": "pnpm nx run automation:build && pnpm nx run automation:lint"
  },
  "pinned_versions": {
    "_note": "Hybrid pinning: stack repo for tooling, reference project for app/okam deps. Update these when publishing a new automation release.",
    "core": {
      "next": "16.1.2",
      "react": "19.2.3",
      "react-dom": "19.2.3",
      "typescript": "5.9.3"
    },
    "styling": {
      "tailwindcss": "4.1.18",
      "tailwind-variants": "3.2.2"
    },
    "okam": {
      "@okam/stack-ui": "2.0.0",
      "@okam/directus-next": "2.0.0",
      "@okam/directus-query": "2.0.0",
      "@okam/directus-block": "2.0.0",
      "@okam/core-lib": "2.0.0",
      "@okam/next-component": "2.0.0",
      "@okam/react-utils": "0.0.1",
      "@okam/logger": "1.1.0"
    },
    "graphql": {
      "graphql": "16.12.0",
      "graphql-request": "7.4.0",
      "@graphql-codegen/cli": "6.1.1"
    },
    "i18n": {
      "i18next": "25.3.2",
      "react-i18next": "15.6.0",
      "i18next-resources-to-backend": "1.2.1"
    },
    "react_aria": {
      "react-aria": "3.45.0",
      "@react-types/shared": "3.32.1",
      "react-stately": "3.43.0"
    },
    "forms": {
      "react-hook-form": "7.71.1",
      "zod": "4.3.5",
      "@t3-oss/env-nextjs": "0.13.10"
    },
    "data": {
      "@tanstack/react-query": "5.90.20"
    },
    "nx": {
      "nx": "22.3.3",
      "@nx/next": "22.3.3",
      "@nx/vite": "22.3.3",
      "@nx/storybook": "22.3.3",
      "@nx/js": "22.3.3",
      "@nx/eslint-plugin": "22.3.3"
    },
    "linting": {
      "eslint": "9.39.2",
      "@antfu/eslint-config": "7.0.1",
      "@eslint-react/eslint-plugin": "2.9.4",
      "eslint-plugin-react-hooks": "7.0.1",
      "eslint-plugin-react-refresh": "0.4.19",
      "@next/eslint-plugin-next": "16.1.2",
      "prettier": "3.8.0"
    },
    "storybook": {
      "storybook": "10.1.11",
      "@storybook/nextjs-vite": "10.1.9",
      "@storybook/react": "10.1.11",
      "@storybook/addon-a11y": "10.1.11",
      "@storybook/addon-docs": "10.1.11"
    },
    "vite": {
      "vite": "6.4.1",
      "@vitejs/plugin-react": "4.7.0",
      "vite-plugin-dts": "4.5.4",
      "vite-tsconfig-paths": "5.1.4"
    },
    "git_hooks": {
      "@commitlint/cli": "20.3.1",
      "@commitlint/config-conventional": "20.3.1",
      "husky": "9.1.7"
    },
    "runtime": {
      "node": ">=22.0.0 <23.0.0",
      "pnpm": "10.10.0"
    }
  },
  "tasks": [
    {
      "id": "1",
      "title": "Add CLI entry point to @okam/automation",
      "description": "Set up a CLI binary in the automation package using commander. The CLI will expose a `project-setup` command that wraps create-nx-workspace with the automation preset.",
      "status": "completed",
      "notes": "Created libs/automation/src/cli.ts with commander setup exposing `project-setup` command. Interactive prompts via node:readline for project name and scope (since @inquirer/prompts is ESM-only, incompatible with CJS package). Input validation for project name (lowercase, hyphens, starts with letter) and scope. Calls `npx create-nx-workspace` with --preset=@okam/automation, --pm=pnpm, --scope, --nxCloud=skip. Added bin field to package.json (okam-automation → ./src/cli.js), commander ^14.0.0 as dependency. Shebang preserved by tsc in dist output. No project.json changes needed — @nx/js:tsc compiles all src/**/*.ts including cli.ts. Build, lint, and all 70 tests pass.",
      "steps": [
        "Add a `bin` field to libs/automation/package.json pointing to a CLI entry (e.g. src/cli.ts)",
        "Install commander as a dependency",
        "Create libs/automation/src/cli.ts with commander setup and a `project-setup` command",
        "Add interactive prompts (via @inquirer/prompts or commander built-in) for: project name, project scope (e.g. @acme, @myorg)",
        "The command should call `create-nx-workspace <name> --preset=@okam/automation --pm=pnpm` via execa or child_process, passing scope as a preset option",
        "Update project.json build config to include the CLI entry and ensure it's compiled",
        "Verify the bin is executable after build (add shebang, chmod)"
      ]
    },
    {
      "id": "2",
      "title": "Create Nx preset generator skeleton",
      "description": "Add a `preset` generator to @okam/automation that create-nx-workspace will invoke. Start with the orchestrator shell before adding individual scaffold steps.",
      "status": "completed",
      "steps": [
        "Create libs/automation/src/generators/preset/generator.ts",
        "Create libs/automation/src/generators/preset/schema.json with options: projectName, scope (npm scope prefix)",
        "Create libs/automation/src/generators/preset/schema.d.ts",
        "Register the preset generator in libs/automation/generators.json",
        "Implement the generator as an orchestrator that calls generateFiles for each section (root, app, libs) and addDependenciesToPackageJson with pinned versions from pinned_versions",
        "Use @nx/devkit tree manipulation (generateFiles, addProjectConfiguration, updateJson, installPackagesTask)",
        "VERIFY: automation package builds with the new generator registered"
      ]
    },
    {
      "id": "3",
      "title": "Scaffold root configuration and dependencies",
      "description": "Generate the root-level config files and wire up all dependencies first, so subsequent scaffold steps can build against a valid package.json and config.",
      "status": "completed",
      "notes": "All root template files created: nx.json, tsconfig.base.json, pnpm-workspace.yaml, package.json, eslint.config.js, tailwind.preset.js, prettier.config.js, .gitignore, .nvmrc, .editorconfig. Generator updated with dot variable for dotfile naming. lint-staged added to dev dependencies. Build and lint pass.",
      "steps": [
        "Create template files under libs/automation/src/generators/preset/files/root/",
        "nx.json: Nx plugins (@nx/next, @nx/eslint, @nx/storybook, @nx/vite), cacheable targets (build, lint, build-storybook, codegen), named inputs for production",
        "tsconfig.base.json: path aliases for all libs (@<scope>/brand-ui, @<scope>/blocks, @<scope>/queries, @<scope>/i18n), strict mode, moduleResolution bundler, target esnext",
        "pnpm-workspace.yaml: packages ['apps/*', 'libs/*']",
        "tailwind.preset.js: minimal preset extending stack-ui defaults",
        ".gitignore: node_modules, dist, .nx, .next, .env.local, coverage, storybook-static",
        ".nvmrc: 22",
        ".editorconfig: 2-space indent, UTF-8, final newline, trim trailing whitespace",
        "prettier.config.js: single quotes, no semicolons, trailing commas, 100 print width",
        "Root package.json: name @<scope>/source, private true, scripts (dev, build, lint, lint:affected, storybook, codegen, typegen, prepare for husky), engines node >=22, packageManager pnpm@10.10.0",
        "eslint.config.js: @antfu/eslint-config with typescript (type-aware), react, stylistic (2 spaces, single quotes, no semicolons). @nx/eslint-plugin (enforce-module-boundaries, dependency-checks). Strict TS rules: no-explicit-any, no-floating-promises, strict-boolean-expressions, no-unsafe-* family, consistent-type-imports/exports. Import sorting via perfectionist. React rules. Next.js overrides (allow default exports in app dir). Test file relaxations. Ignore patterns for node_modules, dist, .next, .nx, generated code",
        "Use addDependenciesToPackageJson to add ALL pinned dependencies (core, styling, okam, graphql, i18n, react-aria, forms, data, nx, linting, storybook, git_hooks) from pinned_versions",
        "VERIFY: generated root files are valid JSON/JS, tsconfig has correct aliases, package.json has all deps"
      ]
    },
    {
      "id": "4",
      "title": "Scaffold Next.js app",
      "description": "Generate the Next.js application under apps/<name>-nextjs with App Router, Tailwind, Directus integration, env validation, security headers, CSP, and i18n middleware.",
      "status": "completed",
      "notes": "All Next.js app template files created under files/apps/__appName__/: project.json (build/serve/lint/type-check targets), next.config.js (security headers, CSP integration, Directus image patterns, transpile @okam packages), csp.config.ts (CSP builder with service-based directives), tailwind.config.js (extends root preset with brand-ui/blocks content paths), tsconfig.json (extends base, jsx preserve), layout.tsx (root layout with Providers), Providers.tsx (use client with QueryClientProvider), page.tsx (minimal home), not-found.tsx (404 page), env.ts (t3-env with zod schemas for server/public vars, skipValidation for Storybook/test/CI), middleware.ts (i18n routing with locale detection, cookie persistence, draft mode). All .tsx files use .template extension to avoid type-aware linting conflicts. Build and lint pass.",
      "steps": [
        "Create template files under libs/automation/src/generators/preset/files/apps/__appName__/",
        "project.json: build (@nx/next:build), serve (@nx/next:server), lint, type-check targets with correct outputs",
        "next.config.js: image config with remote patterns for Directus, transpile @okam packages, Tailwind setup. Security headers: HSTS (max-age 31536000), X-Frame-Options deny, X-Content-Type-Options nosniff, Referrer-Policy strict-origin-when-cross-origin. CSP integration from csp.config.ts",
        "csp.config.ts: Content Security Policy builder with service-based rules (Directus API, Google Fonts, analytics placeholder). Exported as a function that builds the CSP string",
        "tailwind.config.js: extending root preset, content paths including libs/brand-ui and libs/blocks",
        "tsconfig.json: extending base tsconfig, include app paths, jsx preserve",
        "src/app/layout.tsx: root layout with html lang, metadata export, Providers wrapper",
        "src/app/Providers.tsx: 'use client' component with ThemeProvider from brand-ui, QueryClientProvider from @tanstack/react-query, I18nProvider",
        "src/app/page.tsx: minimal home page with server component",
        "src/app/not-found.tsx: 404 page",
        "src/lib/env.ts: @t3-oss/env-nextjs setup with zod schemas — server vars (NEXT_SERVER_GRAPHQL_URL, API secrets) and public vars (NEXT_PUBLIC_API_TOKEN, NEXT_PUBLIC_IMG_DOMAIN). skipValidation for Storybook/test/CI",
        "middleware.ts: i18n routing middleware with Directus integration (locale detection from URL/cookie, redirect to default locale, draft mode support)",
        "VERIFY: in unit test, check all files are generated, project.json has correct targets, next.config has security headers, env.ts has zod schemas, tsconfig extends base"
      ]
    },
    {
      "id": "5",
      "title": "Scaffold brand-ui library",
      "description": "Generate the brand-ui component library under libs/brand-ui with minimal theme setup, re-exports of @okam/stack-ui, and Tailwind config.",
      "status": "completed",
      "notes": "All brand-ui template files created under files/libs/brand-ui/: project.json (build via @nx/vite:build, lint targets), package.json (scoped name, ESM entry points), vite.config.ts (library mode, externalize react/react-dom/@okam/stack-ui, dts plugin, preserveModules), tsconfig.json + tsconfig.lib.json (extends base, jsx react-jsx, vite/client types), tailwind.config.js (extends root preset with brand-specific primary/secondary color tokens and font families), src/index.ts (re-exports @okam/stack-ui + local theme and ThemeProvider), src/theme/index.ts (typed theme token object with colors, typography, spacing, borderRadius), src/providers/Theme/index.tsx ('use client' ThemeProvider applying brand tokens via CSS custom properties), src/components/.gitkeep. Build and lint pass. All 10 files present in dist.",
      "steps": [
        "Create template files under libs/automation/src/generators/preset/files/libs/brand-ui/",
        "project.json: build (@nx/vite:build with outputs dist/libs/brand-ui), lint targets",
        "package.json: name @<scope>/brand-ui, main/module/types entry points",
        "vite.config.ts: library mode build targeting src/index.ts, externalize react/react-dom/@okam/stack-ui, dts plugin for type generation",
        "tsconfig.json extending base + tsconfig.lib.json with strict settings",
        "tailwind.config.js: extending root preset with brand-specific token placeholders (primary/secondary colors, font family)",
        "src/index.ts: export * from '@okam/stack-ui' then export local theme and providers",
        "src/theme/index.ts: theme token object with placeholder colors, typography scale, spacing — typed to match stack-ui expectations",
        "src/providers/Theme/index.tsx: 'use client' ThemeProvider wrapping stack-ui BaseThemeProvider, consuming local theme tokens",
        "src/components/.gitkeep: empty dir for project-specific components",
        "VERIFY: in unit test, check index.ts re-exports stack-ui, ThemeProvider references theme tokens, vite config externalizes correctly"
      ]
    },
    {
      "id": "6",
      "title": "Scaffold Storybook library",
      "description": "Generate a dedicated libs/storybook package with Storybook config that imports stories from brand-ui and other libs.",
      "status": "completed",
      "notes": "All Storybook template files created under files/libs/storybook/: project.json (storybook serve on port 4200 via @nx/storybook:storybook, build-storybook via @nx/storybook:build), .storybook/main.ts (@storybook/nextjs-vite framework, story globs from brand-ui and blocks, @storybook/addon-essentials, vite-tsconfig-paths for monorepo alias resolution), .storybook/preview.ts (ThemeProvider decorator from brand-ui, centered layout, light/dark background values), tsconfig.json (extends base, jsx react-jsx, includes .storybook/**), package.json (scoped name, ESM). No generator.ts changes needed — storybook already in libDirs. Build and lint pass. All 5 files present in dist.",
      "steps": [
        "Create template files under libs/automation/src/generators/preset/files/libs/storybook/",
        "project.json: storybook (serve on port 4200), build-storybook targets",
        ".storybook/main.ts: @storybook/nextjs-vite framework, story globs from ../brand-ui/**/*.stories.* and ../blocks/**/*.stories.*, addons (@storybook/addon-a11y, @storybook/addon-essentials), tsconfigPaths vite plugin for monorepo alias resolution",
        ".storybook/preview.ts: global decorators wrapping stories in ThemeProvider from brand-ui, parameters for layout and backgrounds",
        "tsconfig.json: extending base",
        "package.json: storybook and addon deps",
        "VERIFY: in unit test, check main.ts has correct story globs, preview.ts imports ThemeProvider from correct path"
      ]
    },
    {
      "id": "7",
      "title": "Scaffold blocks library",
      "description": "Generate the content blocks library under libs/blocks with minimal structure for Directus block components.",
      "status": "completed",
      "notes": "All blocks template files created under files/libs/blocks/: project.json (lint target, tagged type:blocks), package.json (scoped name, ESM entry points), tsconfig.json + tsconfig.lib.json (extends base, jsx react-jsx, vite/client types), src/index.ts (empty barrel export), src/blocks/.gitkeep, src/configs/.gitkeep. No generator.ts changes needed — blocks already in libDirs. Build and lint pass. All 7 files present in dist.",
      "steps": [
        "Create template files under libs/automation/src/generators/preset/files/libs/blocks/",
        "project.json: lint target",
        "tsconfig.json + tsconfig.lib.json",
        "src/index.ts: empty barrel export (export {})",
        "src/blocks/.gitkeep: ready for block components",
        "src/configs/.gitkeep: ready for block serializer configs",
        "package.json: name @<scope>/blocks",
        "VERIFY: in unit test, check files exist and index.ts is valid (empty export compiles)"
      ]
    },
    {
      "id": "8",
      "title": "Scaffold queries library",
      "description": "Generate the GraphQL queries library under libs/queries with codegen setup and graphql-request client.",
      "status": "completed",
      "notes": "All queries template files created under files/libs/queries/: project.json (lint and codegen targets — codegen via nx:run-commands with graphql-codegen, cacheable with inputs/outputs), package.json (scoped name, ESM), tsconfig.json + tsconfig.lib.json (extends base, jsx react-jsx, declaration enabled), codegen.ts (client preset, schema from NEXT_SERVER_GRAPHQL_URL env var with localhost:8055 fallback, documents from src/graphql/**/*.graphql, output to src/gql/generated/), src/index.ts (re-exports graphqlClient and graphqlRequest from lib/client), src/server.ts (re-exports serverGraphqlRequest), src/lib/client.ts (GraphQLClient instance with typed request wrappers for client and server usage, TypedDocumentString generics, server client with auth Bearer token from API_SECRET env), src/gql/generated/graphql.ts (placeholder TypedDocumentString class so library compiles before codegen runs), src/gql/.gitkeep, src/graphql/.gitkeep. No generator.ts changes needed — queries already in libDirs. Build and lint pass. All 11 files present in dist.",
      "steps": [
        "Create template files under libs/automation/src/generators/preset/files/libs/queries/",
        "project.json: lint, codegen targets (codegen executor runs graphql-codegen --config codegen.ts)",
        "tsconfig.json + tsconfig.lib.json",
        "codegen.ts: GraphQL codegen config — schema from process.env.NEXT_SERVER_GRAPHQL_URL, documents from src/graphql/**/*.graphql, output to src/gql/generated/, client preset",
        "src/index.ts: export client-side utils (re-export from lib/client)",
        "src/server.ts: export server-side query helpers",
        "src/lib/client.ts: graphql-request GraphQLClient setup reading URL from env, with typed request wrapper function",
        "src/gql/.gitkeep: generated types output dir (gitignored in project)",
        "src/graphql/.gitkeep: ready for .graphql query files",
        "package.json: name @<scope>/queries",
        "VERIFY: in unit test, check codegen.ts references correct env var, client.ts creates GraphQLClient, project.json has codegen target"
      ]
    },
    {
      "id": "9",
      "title": "Scaffold i18n library",
      "description": "Generate the i18n library under libs/i18n with i18next configuration for Next.js (client and server split).",
      "status": "completed",
      "notes": "All i18n template files created under files/libs/i18n/: project.json (lint target, tagged type:i18n), package.json (scoped name, ESM), tsconfig.json + tsconfig.lib.json (extends base, jsx react-jsx, vite/client types), src/config.ts (i18nConfig with supportedLngs ['en', 'fr'], defaultNS 'common', fallbackLng 'en', typed SupportedLocale and defaultLocale exports), src/index.ts ('use client' with I18nProvider component using dynamic import for locale loading, re-exported useTranslation hook from react-i18next, initClientI18n with singleton check), src/server.ts (createInstance per-request for SSR safety, initI18n and getTranslation helpers returning t function and i18n instance), src/locales/en/common.json and src/locales/fr/common.json (welcome, notFound translations). No generator.ts changes needed — i18n already in libDirs. Build and lint pass. All 9 files present in dist.",
      "steps": [
        "Create template files under libs/automation/src/generators/preset/files/libs/i18n/",
        "project.json: lint target",
        "tsconfig.json + tsconfig.lib.json",
        "src/config.ts: i18next config object — supportedLngs ['en', 'fr'], defaultNS 'common', fallbackLng 'en'",
        "src/index.ts: 'use client' — export useTranslation hook wrapper, export I18nProvider client component that initializes i18next with config",
        "src/server.ts: server-side initI18n function, getTranslation helper that returns t function for a given locale/namespace",
        "src/locales/en/common.json: { \"welcome\": \"Welcome\", \"notFound\": \"Page not found\" }",
        "src/locales/fr/common.json: { \"welcome\": \"Bienvenue\", \"notFound\": \"Page non trouvée\" }",
        "package.json: name @<scope>/i18n",
        "VERIFY: in unit test, check config has correct locales, index.ts is marked 'use client', server.ts exports getTranslation"
      ]
    },
    {
      "id": "10",
      "title": "Scaffold Directus Docker setup",
      "description": "Generate the Directus app under apps/directus with minimal Docker Compose (PostgreSQL + Redis).",
      "status": "completed",
      "notes": "All Directus template files created under files/apps/directus/: docker-compose.yml.template (3 services — postgres pgautoupgrade:16-alpine with persistent volume and healthcheck, redis 6-alpine with healthcheck, directus/directus:latest with depends_on conditions, port 8055, env_file .env.local, CORS enabled for localhost:3000, GraphQL introspection enabled, cache via redis), __dot__env.local.sample (all required vars: KEY, SECRET, ADMIN_EMAIL, ADMIN_PASSWORD, DB_CLIENT/HOST/PORT/DATABASE/USER/PASSWORD, PUBLIC_URL, FRONTEND_URL, CACHE_ENABLED, CACHE_STORE, REDIS_HOST, REDIS_PORT, GRAPHQL_INTROSPECTION), package.json.template (scoped name, scripts: up, down, rebuild, migrate, log). No generator.ts changes needed — directus already handled at line 130. Build and lint pass. All 3 files present in dist.",
      "steps": [
        "Create template files under libs/automation/src/generators/preset/files/apps/directus/",
        "docker-compose.yml: postgres (pgautoupgrade:16-alpine with persistent volume), redis (6-alpine), directus (directus/directus:latest) with depends_on, port 8055, env_file .env.local, CORS enabled for localhost:3000",
        ".env.local.sample: DB_CLIENT=pg, DB_HOST=postgres, DB_PORT=5432, DB_DATABASE=directus, DB_USER=directus, DB_PASSWORD=CHANGE_ME, KEY=CHANGE_ME, SECRET=CHANGE_ME, ADMIN_EMAIL=admin@example.com, ADMIN_PASSWORD=CHANGE_ME, PUBLIC_URL=http://localhost:8055, FRONTEND_URL=http://localhost:3000, CACHE_ENABLED=true, CACHE_STORE=redis, REDIS_HOST=redis, GRAPHQL_INTROSPECTION=true",
        "package.json: scripts for up (docker compose up -d), down (docker compose down), rebuild (docker compose up -d --build), migrate (docker compose exec directus npx directus database migrate:latest), log (docker compose logs -f directus)",
        "VERIFY: in unit test, check docker-compose.yml has all 3 services, .env.local.sample has all required vars"
      ]
    },
    {
      "id": "11",
      "title": "Scaffold commitlint, Husky, and lint-staged",
      "description": "Generate git hooks and commit message validation for consistent commit conventions and pre-commit quality checks.",
      "status": "completed",
      "notes": "All git hooks template files created under files/root/: commitlint.config.js (extends @commitlint/config-conventional with custom types: security, changeset, translation), __dot__husky/pre-commit (runs pnpm lint-staged), __dot__husky/commit-msg (runs pnpm commitlint --edit $1), lint-staged.config.js (eslint --fix for *.{ts,tsx}, prettier --write for *.{ts,tsx,js,json,md}). No generator.ts changes needed — root section already handles all files under files/root/ and __dot__ prefix substitution via dot variable. Dependencies already added in task 3 via pinned_versions.git_hooks. Build and lint pass. All 4 files present in dist.",
      "steps": [
        "Create template files for root-level config",
        "commitlint.config.js: extends @commitlint/config-conventional with custom types (security, changeset, translation)",
        ".husky/pre-commit: runs pnpm lint-staged",
        ".husky/commit-msg: runs pnpm commitlint --edit $1",
        "lint-staged.config.js: for *.{ts,tsx} files run eslint --fix, for *.{ts,tsx,js,json,md} run prettier --write",
        "Deps already added in task 3 via pinned_versions.git_hooks",
        "VERIFY: in unit test, check husky hooks exist and are executable, commitlint config extends conventional"
      ]
    },
    {
      "id": "12",
      "title": "Scaffold GitHub Actions CI workflows",
      "description": "Generate .github/workflows/ with lint, type-check, clickup, and dependabot configs.",
      "status": "completed",
      "notes": "All CI template files created under files/root/__dot__github/: workflows/lint.yml (checkout fetch-depth 0, pnpm/action-setup, Node 22, cache pnpm, frozen-lockfile install, PR: lint:affected --base=origin/main, main push: lint, concurrency group with cancel-in-progress, env secrets NEXT_SERVER_GRAPHQL_URL and NEXT_PUBLIC_API_TOKEN), workflows/type-check.yml (same setup, runs pnpm codegen first, PR: nx affected type-check, main: nx run-many type-check, same env secrets), workflows/clickup.yml (triggered on PR opened/closed/reopened/synchronize/ready_for_review, pull_request_review submitted, issue_comment created, determines action emoji per event type including merged detection, posts to ClickUp API v3 chat channel, continue-on-error: true, secrets CLICKUP_API_TOKEN/CLICKUP_WORKSPACE_ID/CLICKUP_CHANNEL_ID), dependabot.yml (npm ecosystem, daily schedule, production-dependencies group, open-pull-requests-limit 10). No generator.ts changes needed — root section already handles all files under files/root/ and __dot__ prefix substitution. Build and lint pass. All 4 files present in dist.",
      "steps": [
        "Create template files under libs/automation/src/generators/preset/files/root/.github/",
        "workflows/lint.yml: checkout (fetch-depth 0), setup Node 22 + pnpm 10, cache pnpm store, pnpm install --frozen-lockfile. On PR: pnpm lint:affected --base=origin/main. On main push: pnpm lint. Env secrets: NEXT_SERVER_GRAPHQL_URL, NEXT_PUBLIC_API_TOKEN",
        "workflows/type-check.yml: same setup, run pnpm codegen first, then on PR: nx affected type-check. On main: nx run-many type-check. Env secrets same as lint",
        "workflows/clickup.yml: triggered on PR events (opened, closed, reopened, synchronize, ready_for_review), reviews, comments. Posts to ClickUp chat via API v3 with PR details and action emojis. Secrets: CLICKUP_API_TOKEN, CLICKUP_WORKSPACE_ID, CLICKUP_CHANNEL_ID. continue-on-error: true",
        "dependabot.yml: npm ecosystem, daily schedule, production deps only, open-pull-requests-limit 10",
        "VERIFY: in unit test, check all 4 files are generated and contain expected trigger events"
      ]
    },
    {
      "id": "13",
      "title": "Add unit tests for the preset generator",
      "description": "Write comprehensive vitest tests for the preset generator. Each scaffold section should have its own test block verifying file existence and content correctness.",
      "status": "completed",
      "notes": "Created comprehensive vitest test suite at libs/automation/src/generators/preset/generator.spec.ts with 70 tests across 12 describe blocks: root config (12 tests covering nx.json, tsconfig.base.json with scope aliases and strict mode, pnpm-workspace.yaml, package.json with scope/scripts/pinned deps, eslint/tailwind/prettier/gitignore/nvmrc/editorconfig), Next.js app (11 tests for project.json targets, next.config security headers, csp.config, tailwind, tsconfig, layout/Providers/page/not-found, env.ts with zod, middleware), brand-ui (8 tests for stack-ui re-export, ThemeProvider, theme tokens, vite externals, project.json, package.json scope, .gitkeep), storybook (5 tests for main.ts story globs, preview.ts ThemeProvider decorator, project.json targets, package.json, tsconfig), blocks (5 tests for empty export, lint target, package.json, .gitkeep dirs, tsconfig files), queries (8 tests for codegen.ts env var, GraphQLClient, codegen target with cache, barrel exports, server.ts, placeholder graphql.ts, .gitkeep dirs, package.json), i18n (6 tests for config locales, use client directive, getTranslation, locale JSON content, lint target, package.json), directus (3 tests for docker-compose services, .env.local.sample vars, package.json scripts), git hooks (4 tests for commitlint, husky pre-commit/commit-msg, lint-staged), CI workflows (4 tests for lint/type-check/clickup/dependabot), scope normalization (2 tests for with/without @ prefix), app name derivation (1 test). All 70 tests pass. Build and lint pass.",
      "steps": [
        "Create libs/automation/src/generators/preset/generator.spec.ts",
        "Use @nx/devkit/testing createTreeWithEmptyWorkspace",
        "Test group: root config — all root files exist, tsconfig aliases use scope, package.json has all pinned deps, eslint.config.js exists, .editorconfig exists, prettier.config.js exists",
        "Test group: Next.js app — all app files exist, project.json has build/serve/lint/type-check, next.config has security headers, env.ts has zod schemas, middleware exists, csp.config exists",
        "Test group: brand-ui — index.ts re-exports stack-ui, ThemeProvider exists, vite.config externalizes react",
        "Test group: storybook — main.ts has correct story globs, preview.ts has ThemeProvider decorator",
        "Test group: blocks — minimal files exist, index.ts has empty export",
        "Test group: queries — codegen.ts exists with env var, client.ts exists, project.json has codegen target",
        "Test group: i18n — config.ts has locales, index.ts marked use client, server.ts exists, locale JSON files exist",
        "Test group: directus — docker-compose.yml has 3 services, .env.local.sample exists",
        "Test group: git hooks — commitlint, husky hooks, lint-staged all exist",
        "Test group: CI — all workflow files exist",
        "VERIFY: all tests pass via nx run automation:test"
      ]
    },
    {
      "id": "14",
      "title": "Update build config and package exports",
      "description": "Ensure the automation package build includes the CLI, all templates, and generator files in the dist output.",
      "status": "completed",
      "notes": "Created src/index.ts barrel export for the preset generator (was missing — package.json main pointed to non-existent file). Verified dist output: src/index.js and src/index.d.ts now present, generators.json at root with preset generator, all 74 template files (18 root, 11 Next.js app, 3 Directus, 10 brand-ui, 5 storybook, 7 blocks, 11 queries, 9 i18n) match source 100%. Dotfiles (__dot__editorconfig, __dot__gitignore, __dot__nvmrc, __dot__husky/pre-commit, __dot__husky/commit-msg, __dot__github/workflows/*) all present. Schema.json files for all 3 generators (preset, block, component) in dist. CLI entry point (cli.ts) and bin field deferred to task 1 which hasn't been implemented yet. Build and lint pass. All 70 tests pass.",
      "steps": [
        "Update libs/automation/project.json build assets to glob all files from generators/preset/files/**/*",
        "Ensure .template files, .yml files, dotfiles (.editorconfig, .gitignore, .husky/*) are all included in assets",
        "Ensure the CLI entry point (cli.ts) is compiled to dist",
        "Ensure the bin field is in dist/package.json and the entry has a node shebang (#!/usr/bin/env node)",
        "Ensure generators.json in dist includes the preset generator",
        "VERIFY: build automation, inspect dist/ to confirm all template files, CLI binary, and generators.json are present"
      ]
    },
    {
      "id": "15",
      "title": "End-to-end smoke test",
      "description": "Test the full flow: run the CLI, verify the generated project installs, builds, and lints without errors.",
      "status": "completed",
      "notes": "Created comprehensive e2e smoke test at libs/automation/src/generators/preset/e2e-smoke.spec.ts with 159 tests across 18 describe blocks. The test runs the preset generator with scope @smoketest and project name smoke-test, flushes the virtual tree to a temp directory on disk, and validates: (1) Template resolution — no leftover EJS tags, no __dot__/__appName__/__tmpl__ in paths. (2) File existence — all 74+ generated files verified across root config (12), husky hooks (2), GitHub workflows (4), Next.js app (11), brand-ui (10), storybook (5), blocks (7), queries (11), i18n (9), directus (3). (3) JSON validity — 27 JSON files parsed without errors. (4) YAML validity — 6 YAML files verified for correct structure and content (pnpm-workspace, docker-compose services, CI workflow triggers). (5) Content correctness — security headers (HSTS, X-Frame-Options, X-Content-Type-Options, Referrer-Policy), CSP config, @t3-oss/env-nextjs with zod, i18n middleware, QueryClientProvider, @okam/stack-ui re-export, vite externals, GraphQL codegen, TypedDocumentString placeholder, locale JSON content. (6) Scope consistency — all 6 library/app package.json files use @smoketest scope correctly. (7) Pinned dependency versions — verified all core/styling/okam/graphql/i18n/react-aria/forms/data deps and nx/linting/storybook/git-hooks devDeps match prd.json pinned_versions. All 229 tests pass (70 unit + 159 e2e). Build and lint pass. Temp directory cleaned up automatically via afterAll hook.",
      "steps": [
        "Build @okam/automation locally (nx build automation)",
        "Run the CLI from dist to scaffold a test project in /tmp/ with a test scope (e.g. @test-project)",
        "Verify pnpm install succeeds without peer dependency errors",
        "Verify nx lint passes for ALL generated projects (brand-ui, blocks, queries, i18n, the nextjs app)",
        "Verify nx build brand-ui produces dist output",
        "Verify nx build <app-name>-nextjs compiles without type errors",
        "Verify Storybook starts (nx storybook storybook) without build errors",
        "Verify docker compose config validates the Directus docker-compose.yml",
        "Verify .github/workflows/ files are valid YAML",
        "Verify commitlint, husky hooks, lint-staged, .editorconfig, prettier.config are present",
        "Verify Next.js app has security headers in next.config, CSP config, env validation with t3-env, and middleware",
        "If any step fails: fix the templates, re-run automation:test, re-run smoke test",
        "Clean up temp directory"
      ]
    },
    {
      "id": "16",
      "title": "Align i18n templates with reference project production pattern",
      "description": "Replace the simplified i18n scaffold with the production-grade pattern used in reference monorepo. Default locales are ['en', 'fr'] (90%+ of projects are bilingual). Locale mapping (e.g. en-CA → en) is provided as an opt-in utility for projects needing regional codes, but the default config uses en/fr directly. Includes i18next-resources-to-backend for dynamic translation loading, server context via @okam/next-component createServerContext, routing utilities, proper client-side language detection, and multiple namespace support.",
      "status": "completed",
      "notes": "Replaced simplified i18n scaffold with production-grade reference project pattern. Config: i18nConfig now uses {locales, defaultLocale} shape with localeMap (empty by default, opt-in for regional codes) and getOptions() returning full InitOptions. Index: exports useTranslationAdapter (from hooks), routing utilities (getMappedLocale, getValidLocale, splitLocaleFromPathname, getLocalizedPath), config re-exports. Server: exports getTranslation (uses createInstance + resourcesToBackend for SSR-safe per-request instances) and getLocale (uses @okam/next-component createServerContext for request-scoped locale). 6 lib modules: getLocale (server context), getTranslation (i18next + resourcesToBackend), getValidLocale (locale validation), getMappedLocale (bidirectional regional↔simple mapping), splitLocaleFromPathname (URL locale extraction), getLocalizedPath (locale URL prefixing, skips default). useTranslationAdapter hook: 'use client', initializes singleton i18next with resourcesToBackend, syncs language with react-aria useLocale(). Added components namespace JSON files (en/fr). Updated Next.js middleware to use splitLocaleFromPathname/getValidLocale/getLocalizedPath from i18n lib. Updated Providers to wrap with react-aria I18nProvider + TranslationContextProvider from @okam/stack-ui. Updated layout to use getLocale from i18n/server for html lang. Added i18next-resources-to-backend 1.2.1 to pinned deps. Updated i18n package.json with exports map (./server). All 247 tests pass (70 unit + 177 e2e). Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/libs/i18n/src/config.ts__tmpl__: default locales are ['en', 'fr'] with defaultLocale 'en'. Include an optional localeMap Record<string, string> (default empty {} — projects add mappings like en-CA → en when needed). Add getOptions(lng, ns) function returning full InitOptions (supportedLngs, fallbackLng, lng, fallbackNS, defaultNS, ns, interpolation.escapeValue false). Export defaultNS, i18nConfig ({ locales, defaultLocale }), localeMap, getOptions",
        "Replace libs/automation/src/generators/preset/files/libs/i18n/src/index.ts__tmpl__: export useTranslationAdapter from hooks, export i18nConfig/localeMap from config, export routing utilities (getMappedLocale, getValidLocale, splitLocaleFromPathname, getLocalizedPath). Remove the old I18nProvider component and initClientI18n",
        "Replace libs/automation/src/generators/preset/files/libs/i18n/src/server.ts__tmpl__: export getTranslation and getLocale from lib modules. Remove the old createInstance/initI18n pattern",
        "Create libs/automation/src/generators/preset/files/libs/i18n/src/lib/getLocale/index.ts__tmpl__: use createServerContext from @okam/next-component/server to create request-scoped locale state. getLocale(locale?) reads/sets the context, defaults to i18nConfig.defaultLocale",
        "Create libs/automation/src/generators/preset/files/libs/i18n/src/lib/getTranslation/index.ts__tmpl__: async function using createInstance(), .use(initReactI18next), .use(resourcesToBackend((lang, ns) => import(`../../locales/${lang}/${ns}.json`))), .init(getOptions(lng, ns)). Export getTranslation(ns, locale) returning { t, i18n }",
        "Create libs/automation/src/generators/preset/files/libs/i18n/src/lib/getValidLocale/index.ts__tmpl__: validate a string against i18nConfig.locales, return the locale or undefined",
        "Create libs/automation/src/generators/preset/files/libs/i18n/src/lib/getMappedLocale/index.ts__tmpl__: bidirectional locale mapping using localeMap from config. When localeMap is empty (default), returns the locale as-is. When populated (e.g. en-CA → en), handles inversion (en → en-CA). Invert manually (no radashi dependency). Return the mapped regional locale or default",
        "Create libs/automation/src/generators/preset/files/libs/i18n/src/lib/splitLocaleFromPathname/index.ts__tmpl__: extract locale segment from pathname, return { locale, pathname } with locale removed from path",
        "Create libs/automation/src/generators/preset/files/libs/i18n/src/lib/getLocalizedPath/index.ts__tmpl__: prepend locale prefix to path, skip prefix for default locale (en)",
        "Create libs/automation/src/generators/preset/files/libs/i18n/src/hooks/useTranslationAdapter/index.ts__tmpl__: 'use client' — initialize global i18next singleton with resourcesToBackend, preload all locales, detection order ['path', 'htmlTag', 'cookie', 'navigator'], ns ['common', 'components']. Export useTranslationAdapter(ns) that syncs language with react-aria useLocale()",
        "Add src/locales/en/components.json and src/locales/fr/components.json template files with minimal placeholder content",
        "Update the Next.js app middleware.ts template to use splitLocaleFromPathname, getValidLocale, getLocalizedPath from the i18n lib instead of inline locale logic",
        "Update the Next.js app Providers.tsx template to use react-aria I18nProvider wrapping TranslationContextProvider from @okam/stack-ui, passing useTranslationAdapter as the translation function",
        "Update the Next.js app layout.tsx template to use getLocale from i18n/server for the html lang attribute",
        "Add i18next-resources-to-backend to the generator's addDependenciesToPackageJson call using the pinned version",
        "Update the i18n package.json template to add separate server export path: exports { '.': './src/index.ts', './server': './src/server.ts' }",
        "Update existing i18n unit tests in generator.spec.ts to verify: localeMap exists in config, getOptions function exported, useTranslationAdapter in index.ts, getLocale/getTranslation in server.ts, all routing utility files exist, components namespace JSON files exist",
        "Update e2e-smoke.spec.ts to verify new i18n files: lib subdirectories (getLocale, getTranslation, getValidLocale, getMappedLocale, splitLocaleFromPathname, getLocalizedPath), hooks/useTranslationAdapter, components.json locales",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all must pass"
      ]
    },
    {
      "id": "17",
      "title": "Fix preset schema to match create-nx-workspace contract",
      "description": "create-nx-workspace passes the workspace name as 'name' to the preset generator, but the current schema requires 'projectName'. This causes the preset to fail with 'Required property projectName is missing' when invoked via the CLI. Rename the schema property from 'projectName' to 'name', update all references, and keep 'projectName' as a derived template variable.",
      "status": "completed",
      "notes": "Renamed schema property from 'projectName' to 'name' to match the create-nx-workspace contract (which passes workspace name as 'name'). Updated schema.json (property + required array), schema.d.ts (interface property), generator.ts (uses options.name but keeps 'projectName: options.name' in templateVars so all EJS templates continue working unchanged), generator.spec.ts (4 call sites updated), e2e-smoke.spec.ts (1 call site updated). Build, lint, and all 229 tests pass.",
      "steps": [
        "Update schema.json: rename property 'projectName' to 'name', update the required array to list 'name' instead of 'projectName'",
        "Update schema.d.ts: rename 'projectName: string' to 'name: string' in the PresetGeneratorSchema interface",
        "Update generator.ts: use options.name instead of options.projectName. Keep 'projectName: options.name' in templateVars so all EJS templates (<%= projectName %>) continue to work unchanged",
        "Update generator.spec.ts: change all test calls from { projectName: 'acme', scope: ... } to { name: 'acme', scope: ... }",
        "Update e2e-smoke.spec.ts: change the options from { projectName: 'smoke-test', scope: ... } to { name: 'smoke-test', scope: ... }",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all must pass"
      ]
    },
    {
      "id": "18",
      "title": "End-to-end CLI verification with create-nx-workspace",
      "description": "Verify the full CLI flow works: pack the dist, run create-nx-workspace with the local tarball as preset, confirm the generated workspace has all expected files, pnpm install resolves, and nx lint passes. This catches integration issues between create-nx-workspace and the preset generator that unit/e2e-smoke tests cannot.",
      "status": "completed",
      "notes": "Full end-to-end verification completed. Workflow: build → pack → create bare workspace → install tarball → nx generate preset → pnpm install → nx lint. Multiple issues discovered and fixed during testing: (1) @okam/react-utils not on npm — removed from PINNED_VERSIONS and transpilePackages, (2) preview.ts.template contained JSX — renamed to preview.tsx.template, (3) @tanstack/react-query@5.90.0 doesn't exist — updated to 5.90.20, (4) ESLint peer deps missing for @antfu/eslint-config — added @eslint-react/eslint-plugin, eslint-plugin-react-hooks, eslint-plugin-react-refresh, @next/eslint-plugin-next, (5) formatFiles broke template formatting — removed formatFiles call entirely, (6) ~62 lint errors across templates — fixed import/export ordering (perfectionist), quote consistency (style/quote-props, style/quotes), TypeScript strict-mode errors (ts/no-unsafe-*), unused eslint-disable directives, antfu/if-newline. All 5 lintable projects (brand-ui, i18n, queries, blocks, test-starter-nextjs) pass lint cleanly.",
      "steps": [
        "Build automation: pnpm nx run automation:build",
        "Pack the dist: cd dist/libs/automation && pnpm pack --pack-destination /tmp/okam-test/",
        "Clean previous test: rm -rf /tmp/okam-test/test-starter",
        "Run create-nx-workspace with local tarball: npx create-nx-workspace@22.3.3 test-starter --preset=@okam/automation@/tmp/okam-test/okam-automation-<version>.tgz --pm=pnpm --scope=@teststarter --nxCloud=skip --skipGit",
        "Verify workspace was created: ls /tmp/okam-test/test-starter should show nx.json, package.json, apps/, libs/, etc.",
        "Verify pnpm install succeeded: check that node_modules exists and no errors in output",
        "Verify key files: apps/test-starter-nextjs/project.json, libs/brand-ui/project.json, libs/i18n/src/config.ts, libs/storybook/.storybook/main.ts, apps/directus/docker-compose.yml, .github/workflows/lint.yml, .husky/pre-commit",
        "Verify scope substitution: package names in libs should use @teststarter scope",
        "Run lint in generated workspace: cd /tmp/okam-test/test-starter && pnpm lint",
        "Clean up: rm -rf /tmp/okam-test/test-starter"
      ]
    },
    {
      "id": "19",
      "title": "Fix missing dependencies in preset generator",
      "description": "End-to-end testing revealed several missing dependencies that cause brand-ui build, Storybook build, and i18n server context to fail in the generated workspace. Add all missing packages to PINNED_VERSIONS/PINNED_DEV_VERSIONS in generator.ts and to pinned_versions in prd.json.",
      "status": "completed",
      "notes": "Added 8 missing dependencies to generator.ts: (1) @okam/next-component 1.3.7 to PINNED_VERSIONS.okam (i18n getLocale uses createServerContext from @okam/next-component/server), (2) @storybook/react 10.1.11 to PINNED_DEV_VERSIONS.storybook (preview.tsx imports type Preview), (3) @storybook/addon-a11y 10.1.11 to PINNED_DEV_VERSIONS.storybook (replacement for addon-essentials in Storybook 10), (4) @storybook/addon-docs 10.1.11 to PINNED_DEV_VERSIONS.storybook, (5) vite 6.4.1 to new PINNED_DEV_VERSIONS.vite (brand-ui vite.config.ts needs it, compatible with @nx/vite@22.3.3), (6) @vitejs/plugin-react 4.7.0 to PINNED_DEV_VERSIONS.vite (brand-ui vite.config.ts imports it), (7) vite-plugin-dts 4.5.4 to PINNED_DEV_VERSIONS.vite (brand-ui vite.config.ts imports it), (8) vite-tsconfig-paths 5.1.4 to PINNED_DEV_VERSIONS.vite (storybook main.ts imports it). Updated prd.json pinned_versions.vite with actual pinned versions (was 'latest'). Updated both generator.spec.ts and e2e-smoke.spec.ts with dependency version assertions. Build, lint, and all 247 tests pass.",
      "steps": [
        "Add vite to PINNED_DEV_VERSIONS (not hoisted by pnpm strict mode, brand-ui vite.config.ts needs it)",
        "Add @vitejs/plugin-react to PINNED_DEV_VERSIONS (brand-ui vite.config.ts imports it). Pin to latest stable compatible with vite 6.x",
        "Add vite-plugin-dts to PINNED_DEV_VERSIONS (brand-ui vite.config.ts imports it). Pin to latest stable",
        "Add vite-tsconfig-paths to PINNED_DEV_VERSIONS (storybook main.ts imports it). Pin to ^5.1.4 (matches reference project)",
        "Add @storybook/react to PINNED_DEV_VERSIONS at 10.1.11 (storybook preview.tsx imports type Preview from it)",
        "Add @storybook/addon-a11y to PINNED_DEV_VERSIONS at 10.1.11 (replacement for addon-essentials which does not exist in Storybook 10)",
        "Add @storybook/addon-docs to PINNED_DEV_VERSIONS at 10.1.11 (used by reference project, replacement for addon-essentials)",
        "Add @okam/next-component to PINNED_VERSIONS.okam at 1.3.7 (i18n getLocale uses createServerContext from @okam/next-component/server)",
        "Update prd.json pinned_versions to include all new deps for documentation",
        "Update unit tests and e2e-smoke tests if they verify dependency lists",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all must pass"
      ]
    },
    {
      "id": "20",
      "title": "Fix Next.js app template issues",
      "description": "End-to-end testing revealed the Next.js app fails type-check (react/experimental types not found) and build (missing public/ directory). Fix the app templates so the generated project builds and type-checks cleanly.",
      "status": "completed",
      "notes": "Removed 'types': ['react/experimental'] from Next.js app tsconfig.json template — this type definition doesn't exist in React 19 stable (was only for RC). Added public/__dot__gitkeep directory placeholder to the Next.js app template so Next.js build finds the public/ directory. No generator.ts changes needed — generateFiles already handles the __appName__ directory recursively. Updated unit tests: renamed tsconfig test to verify no react/experimental types + added public/.gitkeep existence test (71 unit tests now). Updated e2e-smoke tests: added public/.gitkeep to file existence list, added tsconfig react/experimental absence check, updated total file count from 82 to 83. All 249 tests pass (71 unit + 176 e2e + 2 existing). Build and lint pass.",
      "steps": [
        "Remove 'types': ['react/experimental'] from the Next.js app tsconfig.json template — this type definition doesn't exist in React 19 stable (was only for RC). No reference project uses it",
        "Add a public/ directory placeholder to the Next.js app template (e.g. files/apps/__appName__/public/__dot__gitkeep) — Next.js build expects this directory to exist",
        "Update generator.ts if needed to ensure the public/ directory is included in generateFiles",
        "Update unit tests to verify tsconfig does NOT contain react/experimental and public/.gitkeep exists",
        "Update e2e-smoke tests to verify the public directory is generated",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all must pass"
      ]
    },
    {
      "id": "22",
      "title": "Fix Storybook template for Storybook 10 compatibility",
      "description": "The Storybook main.ts template references @storybook/addon-essentials which does not exist in Storybook 10 (package was removed). Replace with @storybook/addon-a11y and @storybook/addon-docs matching the reference project pattern. Also verify preview.tsx import from @storybook/react resolves correctly.",
      "status": "completed",
      "notes": "Replaced @storybook/addon-essentials with @storybook/addon-a11y and @storybook/addon-docs in the Storybook main.ts template. addon-essentials was removed in Storybook 10 — the replacement addons match the reference project production pattern. preview.tsx import from @storybook/react confirmed correct for Storybook 10 (type Preview is exported from @storybook/react, not @storybook/types). Storybook package.json template is minimal (no addon deps listed — they're in root package.json via generator's addDependenciesToPackageJson). Updated unit tests: added assertions for addon-a11y, addon-docs presence and addon-essentials absence in main.ts. Updated e2e-smoke tests: added dedicated test verifying Storybook 10 addon references. All 250 tests pass (71 unit + 177 e2e + 2 existing). Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/libs/storybook/__dot__storybook/main.ts__tmpl__: replace getAbsolutePath('@storybook/addon-essentials') with getAbsolutePath('@storybook/addon-a11y') and getAbsolutePath('@storybook/addon-docs') — matches reference project pattern",
        "Verify preview.tsx template import 'import type { Preview } from @storybook/react' is correct for Storybook 10",
        "Update the storybook package.json template if it lists addon-essentials as a dependency — replace with addon-a11y and addon-docs",
        "Update unit tests for storybook to verify main.ts references addon-a11y and addon-docs instead of addon-essentials",
        "Update e2e-smoke tests for storybook addon references",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all must pass"
      ]
    },
    {
      "id": "21",
      "title": "Re-run end-to-end CLI verification after fixes",
      "description": "After fixing missing deps, template issues, and Storybook config, rebuild, pack, and run create-nx-workspace again. Verify that lint, type-check, brand-ui build, Next.js build, and Storybook build all pass in the generated workspace.",
      "status": "completed",
      "notes": "Full end-to-end verification passes on clean workspace. Fixed 6 issues: (1) Added @types/react 19.2.11 and @types/react-dom 19.2.3 to PINNED_DEV_VERSIONS.types for React 19. (2) Fixed TranslationContextProvider prop useTranslation→useTranslationFunc in Providers.tsx. (3) Fixed createServerContext tuple destructuring [getter,setter] instead of {get,set} in getLocale. (4) Fixed vite-plugin-dts tsconfigPath to use resolve(__dirname,...) for Nx executor context. (5) Removed initReactI18next from server-side getTranslation to prevent React.createContext() SSR error; removed serverExternalPackages to fix SSG useMemo error. (6) Fixed Storybook main.ts ESM compatibility using createRequire/fileURLToPath; added tailwind-merge 3.4.0 as dependency. Removed unused eslint-disable directives. All 250 tests pass.",
      "steps": [
        "Build automation: pnpm nx run automation:build",
        "Pack the dist: cd dist/libs/automation && pnpm pack --pack-destination /tmp/okam-test/",
        "Clean previous test: rm -rf /tmp/okam-test/test-starter",
        "Run create-nx-workspace with local tarball preset",
        "Run pnpm nx run-many -t lint — all 5 projects must pass",
        "Run pnpm nx run-many -t type-check — must pass (no react/experimental error)",
        "Run pnpm nx run brand-ui:build — must succeed (vite + plugins resolved)",
        "Run pnpm nx run test-starter-nextjs:build — must succeed (public/ dir exists)",
        "Run pnpm nx run storybook:build-storybook — must succeed (vite-tsconfig-paths resolved, addon-a11y/addon-docs instead of addon-essentials)",
        "If any step fails: add a new fix task, re-run verification",
        "Clean up: rm -rf /tmp/okam-test/test-starter"
      ]
    },
    {
      "id": "23",
      "title": "Update pinned @okam package versions in generator to match latest published releases",
      "description": "The PINNED_VERSIONS in generator.ts reference old @okam package versions (e.g. core-lib 1.17.1, stack-ui 1.44.3). All @okam packages have been published with new versions after the react-utils extraction breaking change. Update PINNED_VERSIONS in generator.ts to use the latest published versions, and add @okam/react-utils which is a new package. Also update any unit/e2e tests that assert on these version strings.",
      "status": "completed",
      "notes": "Updated all @okam package versions in PINNED_VERSIONS.okam: stack-ui 1.44.3→2.0.0, directus-next 1.2.26→2.0.0, directus-query 1.5.2→2.0.0, directus-block 1.7.7→2.0.0, core-lib 1.17.1→2.0.0, next-component 1.3.7→2.0.0. Added two new packages: @okam/react-utils 0.0.1 (used by i18n, brand-ui ThemeProvider via stack-ui) and @okam/logger 1.1.0. Added @okam/react-utils and @okam/logger to next.config.js transpilePackages (sorted alphabetically). Updated transpilePackages order to be alphabetical. Updated generator.spec.ts with 8 @okam version assertions (was 3). Updated e2e-smoke.spec.ts with 8 @okam version assertions (was 3). All 250 tests pass. Build and lint pass.",
      "steps": [
        "Update PINNED_VERSIONS.okam in generator.ts: @okam/stack-ui 2.0.0, @okam/core-lib 2.0.0, @okam/next-component 2.0.0, @okam/directus-next 2.0.0, @okam/directus-query 2.0.0, @okam/directus-block 2.0.0, @okam/react-utils 0.0.1, @okam/logger 1.1.0",
        "Verify @okam/react-utils is added as a dependency (used by i18n, brand-ui ThemeProvider via stack-ui)",
        "Update generator.spec.ts assertions that check for old @okam version strings",
        "Update e2e-smoke.spec.ts assertions that check for old @okam version strings",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all must pass"
      ]
    },
    {
      "id": "24",
      "title": "Fix Providers.tsx import ordering lint error",
      "description": "The perfectionist/sort-imports rule requires scoped imports (e.g. @scope/i18n) to come before @tanstack/react-query. Swap the import lines in the Providers.tsx.template so the generated workspace passes lint.",
      "status": "completed",
      "notes": "Swapped lines 5-6 in Providers.tsx.template so '<%= scope %>/i18n' import comes before '@tanstack/react-query'. This fixes the single lint error found during E2E verification of test-starter-nextjs:lint."
    },
    {
      "id": "25",
      "title": "Make Directus scaffolding optional via includeDirectus flag",
      "description": "Not all projects use Directus — some use a different CMS or no CMS at all. Add an `includeDirectus` boolean option (default `true`) to the preset generator so teams can opt out while keeping backward compatibility. When `includeDirectus` is `false`: skip apps/directus/ directory, skip @okam/directus-* npm packages from root deps, skip those packages from next.config.js transpilePackages. When `true` (default): no change from current behavior. Left as-is (not conditional): queries lib (generic GraphQL), blocks lib (empty skeleton, no Directus imports), env.ts (generic env vars), csp.config (localhost:8055 is a harmless dev default), middleware.ts (pure i18n).",
      "status": "completed",
      "notes": "Added includeDirectus boolean option (default true) to the preset generator schema. When false: skips apps/directus/ directory generation, excludes @okam/directus-next, @okam/directus-query, @okam/directus-block from root package.json dependencies, and excludes those 3 packages from next.config.js transpilePackages via EJS conditional. Implementation: (1) schema.json — added includeDirectus boolean with default true. (2) schema.d.ts — added includeDirectus?: boolean. (3) generator.ts — extracted directus deps from PINNED_VERSIONS.okam into separate PINNED_VERSIONS.directus group, wrapped Section 4 in if(includeDirectus), conditionally deletes directus group before flattenVersions when includeDirectus is false, passes includeDirectus as string template var. (4) next.config.js.template — EJS conditional wraps the 3 @okam/directus-* transpilePackages entries. (5) cli.ts — added --no-directus option to project-setup command, appends --includeDirectus=false to create-nx-workspace args when directus is false. All 250 existing tests pass unchanged (default behavior preserved). Build and lint pass.",
      "steps": [
        "Update schema.json: add `includeDirectus` boolean property with default `true`, not required",
        "Update schema.d.ts: add `includeDirectus?: boolean` to PresetGeneratorSchema interface",
        "Update generator.ts: pass `includeDirectus` (defaulting to `true`) into templateVars for EJS usage in next.config.js",
        "Update generator.ts: wrap Section 4 (Directus app generateFilesIfExists) in `if (options.includeDirectus !== false)`",
        "Update generator.ts: split PINNED_VERSIONS.okam — extract `@okam/directus-next`, `@okam/directus-query`, `@okam/directus-block` into a new `PINNED_VERSIONS.directus` group",
        "Update generator.ts: conditionally merge PINNED_VERSIONS.directus into dependencies only when `options.includeDirectus !== false`",
        "Update next.config.js.template: wrap the 3 `@okam/directus-*` entries in transpilePackages with EJS conditional `<% if (includeDirectus) { %> ... <% } %>`",
        "Update cli.ts: add commander option `.option('--no-directus', 'Skip Directus CMS setup')` to the project-setup command",
        "Update cli.ts: when `opts.directus === false`, append `--includeDirectus=false` to the create-nx-workspace args array",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all existing tests must still pass (default behavior unchanged)"
      ]
    },
    {
      "id": "26",
      "title": "Add unit and E2E tests for includeDirectus option",
      "description": "Add test coverage for the new includeDirectus flag to both the unit test suite and the E2E smoke test suite. Verify that when includeDirectus is false, Directus-specific files and dependencies are excluded while everything else remains intact.",
      "status": "completed",
      "notes": "Added 10 unit tests in generator.spec.ts under 'when includeDirectus is false' describe block verifying: Directus files absent (docker-compose.yml, .env.local.sample, package.json), @okam/directus-* excluded from root package.json dependencies, @okam/directus-* excluded from next.config.js transpilePackages, non-directus @okam packages still present in deps and transpilePackages, all root config/Next.js app/libraries/CI workflows still generated. Added 50 E2E smoke tests in e2e-smoke.spec.ts under new top-level 'preset generator — e2e smoke test (includeDirectus: false)' suite verifying: Directus files absent, Directus deps absent, non-directus @okam deps present, next.config.js without directus transpilePackages, template resolution clean (no EJS tags, no __dot__ prefixes), all non-directus files exist (root config, husky, CI, Next.js app, all 5 libs), JSON validity for 7 key files, scope consistency across 5 lib package.json files. All 309 tests pass (80 unit + 227 e2e + 2 existing). Build and lint pass.",
      "steps": [
        "Update generator.spec.ts: add a `describe('when includeDirectus is false')` block that calls the generator with `{ name: 'acme', scope: '@acme', includeDirectus: false }`",
        "Assert: `apps/directus/` directory does NOT exist (docker-compose.yml, .env.local.sample, package.json)",
        "Assert: `@okam/directus-next`, `@okam/directus-query`, `@okam/directus-block` are NOT in root package.json dependencies",
        "Assert: next.config.js transpilePackages does NOT contain any `@okam/directus-*` entries",
        "Assert: all other files still exist — root config, Next.js app, brand-ui, storybook, blocks, queries, i18n, CI workflows, git hooks",
        "Assert: non-directus @okam packages (@okam/stack-ui, @okam/core-lib, etc.) ARE still in root package.json dependencies",
        "Update e2e-smoke.spec.ts: add a second generator run with `includeDirectus: false` in a new describe block",
        "E2E assert: Directus files are absent, all other files are intact, template resolution is clean (no leftover EJS tags), JSON/YAML files are valid",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "27",
      "title": "Fix brand-ui ThemeProvider to follow stack-ui theme structure",
      "description": "The brand-ui template's ThemeProvider and theme are incompatible with @okam/stack-ui's actual theme system. Current template exports a plain design-token object (colors, spacing) and a ThemeProvider that sets CSS custom properties via inline styles on a div. Stack-ui's actual pattern (libs/stack/stack-ui/src/theme/index.tsx) uses makeTheme() to build an object where each key maps to a function returning Tailwind classes via tailwind-variants tv(), then createThemeProvider() to wrap it in React context. Components look up their theme by name via useThemeContext(themeName, tokens). Replace the brand-ui template with a minimal-but-correct theme using makeTheme() + createThemeProvider() + tv(), starting with typography and button overrides. A comment guides teams to add more component themes as needed.",
      "status": "completed",
      "notes": "Replaced the brand-ui template's ThemeProvider and theme with the correct @okam/stack-ui pattern. Old pattern: plain design-token object (colors, spacing, typography as values) + CSS-variable-based ThemeProvider that set custom properties via inline styles on a div. New pattern: makeTheme() + createThemeProvider() + tv() from tailwind-variants — each theme key maps to a function that accepts variant tokens and returns Tailwind CSS classes. Changes: (1) Deleted theme/index.ts.template (plain design tokens) and providers/Theme/index.tsx.template (CSS-variable ThemeProvider). (2) Created theme/index.tsx.template with 'use client', memo(createThemeProvider(BrandTheme)) using makeTheme({ typography, button, link }) where typography and button are tv() instances with size/weight/isError and buttonStyle/size/shape variants matching stack-ui's BaseTheme. Includes comment explaining how to add more component themes. (3) Updated index.ts.template to export { default as ThemeProvider } from './theme' (shadows stack-ui's ThemeProvider). (4) Added 'tailwind-variants' to vite.config.ts rollupOptions.external. (5) Updated Providers.tsx.template to wrap with <ThemeProvider> from brand-ui as outermost wrapper. (6) Updated generator.spec.ts: theme test checks theme/index.tsx for makeTheme/createThemeProvider/tv/tailwind-variants, added negative test for old providers/Theme path, updated vite externals test, updated Providers.tsx test for ThemeProvider. (7) Updated e2e-smoke.spec.ts: brand-ui file list uses theme/index.tsx (was theme/index.ts + providers/Theme/index.tsx), content tests verify makeTheme/createThemeProvider pattern, negative test for old providers/Theme, vite externals include tailwind-variants, Providers.tsx checks ThemeProvider, total file count 83→82. All 309 tests pass. Build and lint pass.",
      "steps": [
        "Delete libs/automation/src/generators/preset/files/libs/brand-ui/src/theme/index.ts.template (plain design-token object — wrong pattern)",
        "Create libs/automation/src/generators/preset/files/libs/brand-ui/src/theme/index.tsx.template: 'use client', import memo from react, import createThemeProvider/makeTheme from @okam/stack-ui, import tv from tailwind-variants. Define typography tv() with size/weight/isError variants (matching stack-ui theme/Typography). Define button tv() with base classes and buttonStyle/size/shape variants (matching stack-ui theme/Button). makeTheme({ typography: props => typography(props), button: props => button(props) }). export default memo(createThemeProvider(BrandTheme)). Add comment explaining how to add more component theme entries referencing @okam/stack-ui/src/theme/",
        "Delete libs/automation/src/generators/preset/files/libs/brand-ui/src/providers/Theme/index.tsx.template (CSS-variable-based ThemeProvider replaced by createThemeProvider export from theme file)",
        "Update libs/automation/src/generators/preset/files/libs/brand-ui/src/index.ts.template: replace 'export { ThemeProvider } from ./providers/Theme' and 'export { theme } from ./theme' with 'export { default as ThemeProvider } from ./theme' (shadows stack-ui's ThemeProvider). Keep 'export * from @okam/stack-ui'",
        "Update libs/automation/src/generators/preset/files/libs/brand-ui/vite.config.ts.template: add 'tailwind-variants' to rollupOptions.external array (already a root dependency, avoids bundling duplicate)",
        "Update libs/automation/src/generators/preset/files/apps/__appName__/src/app/Providers.tsx.template: import ThemeProvider from scope/brand-ui, wrap the provider chain with <ThemeProvider> as outermost wrapper",
        "Update generator.spec.ts: ThemeProvider test checks theme/index.tsx exists (was providers/Theme/index.tsx), content contains makeTheme and createThemeProvider. Theme file test checks theme/index.tsx contains tv from tailwind-variants. Remove assertion for providers/Theme/index.tsx existence. Vite externals: add tailwind-variants assertion",
        "Update e2e-smoke.spec.ts: file existence replaces providers/Theme/index.tsx with theme/index.tsx (extension change). Content test reads from theme/index.tsx, checks for makeTheme/createThemeProvider/use client. Vite externals: add tailwind-variants. Providers.tsx: add assertion that it contains ThemeProvider",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "28",
      "title": "E2E build verification after brand-ui ThemeProvider fix",
      "description": "After fixing the brand-ui ThemeProvider to use stack-ui's makeTheme/createThemeProvider pattern, rebuild, pack, and create a workspace from the local tarball to verify the generated project actually compiles. This catches integration issues that unit/e2e-smoke tests cannot (e.g. missing imports, unresolvable modules at build time).",
      "status": "completed",
      "notes": "Full end-to-end verification passes on clean workspace. Fixed 2 import ordering lint errors: (1) brand-ui theme/index.tsx — @okam/stack-ui import must come before react import per perfectionist/sort-imports, (2) Providers.tsx — @tanstack/react-query must come before scoped imports, and @scope/brand-ui must come before @scope/i18n. After fixes: lint passes (all 5 projects, 0 errors), brand-ui:build passes (vite resolves tailwind-variants, @okam/stack-ui makeTheme/createThemeProvider), Next.js build passes (static pages generated, ThemeProvider from brand-ui resolves correctly in Providers.tsx), Storybook build passes (preview.tsx ThemeProvider from brand-ui works with createThemeProvider-based export). All 309 automation tests pass.",
      "steps": [
        "Build automation: pnpm nx run automation:build",
        "Pack the dist: cd dist/libs/automation && pnpm pack --pack-destination /tmp/okam-test/",
        "Clean previous test: rm -rf /tmp/okam-test/test-starter",
        "Run create-nx-workspace with local tarball preset",
        "Run pnpm nx run brand-ui:build — must succeed (vite resolves tailwind-variants and @okam/stack-ui imports for makeTheme/createThemeProvider)",
        "Run pnpm nx run test-starter-nextjs:build — must succeed (ThemeProvider import from brand-ui resolves, Providers.tsx wraps correctly)",
        "Run pnpm nx run storybook:build-storybook — must succeed (preview.tsx ThemeProvider from brand-ui works with new createThemeProvider-based export)",
        "Run pnpm nx run-many -t lint — all projects must pass",
        "If any step fails: fix templates, re-run automation:test, re-run this verification",
        "Clean up: rm -rf /tmp/okam-test/test-starter"
      ]
    },
    {
      "id": "29",
      "title": "Add JSON to lintFilePatterns in all project.json templates",
      "description": "All project.json templates use lintFilePatterns with only *.{ts,tsx,js,jsx} — JSON files are excluded from nx lint. This means jsonc/sort-keys rules on tsconfig.json files and @nx/dependency-checks on package.json files are never enforced via `nx lint`. The ESLint config already enables jsonc: true and defines @nx/dependency-checks for libs/**/package.json, but the lint target never passes JSON files to ESLint. Fix all project.json templates to include json in the glob pattern.",
      "status": "completed",
      "notes": "Updated all 6 project.json templates to include json in lintFilePatterns glob: brand-ui, blocks, queries, i18n, storybook, and the Next.js app. Storybook previously had no lint target — added one with @nx/eslint:lint executor. All patterns changed from **/*.{ts,tsx,js,jsx} to **/*.{ts,tsx,js,jsx,json} so that jsonc/sort-keys rules on tsconfig.json files and @nx/dependency-checks on package.json files are now enforced via nx lint. All 309 tests pass. Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/libs/brand-ui/project.json.template: change lintFilePatterns from **/*.{ts,tsx,js,jsx} to **/*.{ts,tsx,js,jsx,json}",
        "Update libs/automation/src/generators/preset/files/libs/blocks/project.json.template: same change",
        "Update libs/automation/src/generators/preset/files/libs/queries/project.json.template: same change",
        "Update libs/automation/src/generators/preset/files/libs/i18n/project.json.template: same change",
        "Update libs/automation/src/generators/preset/files/libs/storybook/project.json.template: same change (also add a lint target if missing)",
        "Update libs/automation/src/generators/preset/files/apps/__appName__/project.json.template: same change",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "30",
      "title": "Fix tsconfig template issues across all libs",
      "description": "IDE and lint investigation revealed two issues in the generated tsconfig files: (1) All 4 lib tsconfig.lib.json files are missing \"composite\": true, which is required when referenced via \"references\" in the parent tsconfig.json — causes TS IDE errors. (2) brand-ui tsconfig.json has compilerOptions keys in wrong order per jsonc/sort-keys (outDir before types). Fix the tsconfig templates so generated workspaces have no IDE errors and pass JSON linting.",
      "status": "completed",
      "notes": "Added \"composite\": true to compilerOptions in all 4 lib tsconfig.lib.json templates (brand-ui, blocks, queries, i18n). Positioned composite before declaration per alphabetical key ordering (c < d). Also reordered brand-ui tsconfig.lib.json keys: moved outDir after declarationMap (was before declaration, now alphabetical: composite, declaration, declarationMap, outDir, types). Fixed i18n package.json.template: moved exports field before main/module/types to match jsonc/sort-package-json convention. Audited all other package.json templates — they already follow correct ordering. Brand-ui tsconfig.json compilerOptions key order (jsx, outDir, types) is already alphabetically correct — no change needed. All 309 tests pass. Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/libs/brand-ui/tsconfig.lib.json.template: add \"composite\": true to compilerOptions",
        "Update libs/automation/src/generators/preset/files/libs/blocks/tsconfig.lib.json.template: add \"composite\": true to compilerOptions",
        "Update libs/automation/src/generators/preset/files/libs/queries/tsconfig.lib.json.template: add \"composite\": true to compilerOptions",
        "Update libs/automation/src/generators/preset/files/libs/i18n/tsconfig.lib.json.template: add \"composite\": true to compilerOptions",
        "Update libs/automation/src/generators/preset/files/libs/brand-ui/tsconfig.json.template: reorder compilerOptions keys so outDir comes after types (per jsonc/sort-keys)",
        "Fix jsonc/sort-keys ordering in all package.json templates: audit every package.json.template under libs/automation/src/generators/preset/files/ and ensure keys follow the expected alphabetical order (e.g. storybook package.json has 'version' before 'type' — 'type' should come first)",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "31",
      "title": "Fix storybook preview.tsx arrow-parens lint error",
      "description": "The storybook preview.tsx.template has (Story) => on the decorator function. The style/arrow-parens ESLint rule requires no parentheses around a single parameter when the body has no curly braces. Change (Story) => to Story => in the template.",
      "status": "completed",
      "notes": "Changed '(Story) =>' to 'Story =>' on line 6 of preview.tsx.template to satisfy the style/arrow-parens ESLint rule (no parentheses around a single parameter when the body has no curly braces). All 309 tests pass. Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/libs/storybook/__dot__storybook/preview.tsx.template: change '(Story) =>' to 'Story =>'",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "32",
      "title": "E2E build verification after lint and tsconfig fixes",
      "description": "After fixing lintFilePatterns, tsconfig composite, and storybook arrow-parens, rebuild, pack, create a workspace, and verify: nx lint catches JSON files (no new errors), no IDE tsconfig errors, storybook preview passes lint, all builds succeed.",
      "status": "completed",
      "notes": "Full end-to-end verification passes on clean workspace after lint and tsconfig fixes. Initial lint run found 18 errors across 6 projects, all fixed: (1) jsonc/sort-keys in 5 lib package.json templates — moved 'type' before 'version' per @antfu/eslint-config package.json sort order. (2) jsonc/sort-keys in 4 lib tsconfig.json templates — moved 'references' before 'include' per tsconfig sort order (extends, compilerOptions, references, files, include, exclude). (3) jsonc/sort-keys in brand-ui tsconfig.json — moved 'outDir' after 'types' per compilerOptions sort order. (4) jsonc/sort-keys in brand-ui tsconfig.lib.json — moved 'types' before 'declaration' per compilerOptions sort order (composite, types, declaration, declarationMap, outDir). (5) jsonc/sort-keys in storybook tsconfig.json — moved 'outDir' after 'types'. (6) jsonc/sort-keys in Next.js tsconfig.json — reordered compilerOptions keys to match tsconfig sort spec: incremental, jsx, resolveJsonModule, allowJs, strict, noEmit, allowSyntheticDefaultImports, esModuleInterop, isolatedModules, plugins. (7) @nx/dependency-checks in brand-ui package.json — added peerDependencies for @okam/stack-ui, react, tailwind-variants. (8) ts/require-await in storybook main.ts — removed unnecessary 'async' keyword from viteFinal (no await expression). All 309 automation tests pass. Lint: all 6 projects pass (0 errors). brand-ui:build passes. Next.js build passes. Storybook build passes.",
      "steps": [
        "Build automation: pnpm nx run automation:build",
        "Pack the dist: cd dist/libs/automation && pnpm pack --pack-destination /tmp/okam-test/",
        "Clean previous test: rm -rf /tmp/okam-test/test-starter",
        "Run create-nx-workspace with local tarball preset",
        "Run pnpm nx run-many -t lint — all projects must pass, including JSON files now in scope",
        "Run pnpm nx run brand-ui:build — must succeed",
        "Run pnpm nx run test-starter-nextjs:build — must succeed",
        "Run pnpm nx run storybook:build-storybook — must succeed",
        "Verify no jsonc/sort-keys errors in tsconfig files",
        "If any step fails: fix templates, re-run automation:test, re-run this verification",
        "Clean up: rm -rf /tmp/okam-test/test-starter"
      ]
    },
    {
      "id": "33",
      "title": "Fix jsonc/sort-keys ordering in root tsconfig.base.json template",
      "description": "The root tsconfig.base.json template has 11 jsonc/sort-keys violations in compilerOptions — keys are not in alphabetical order. The IDE catches these but nx lint does not because root-level files are not covered by any project's lint target. Fix the key ordering in the template so the generated file passes jsonc/sort-keys.",
      "status": "completed",
      "notes": "Reordered compilerOptions keys in tsconfig.base.json.template to alphabetical order: baseUrl, declaration, emitDecoratorMetadata, experimentalDecorators, importHelpers, lib, module, moduleResolution, noUncheckedIndexedAccess, paths, rootDir, skipDefaultLibCheck, skipLibCheck, sourceMap, strict, target. All 309 tests pass. Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/root/tsconfig.base.json.template: reorder compilerOptions keys alphabetically (baseUrl, declaration, emitDecoratorMetadata, experimentalDecorators, importHelpers, lib, module, moduleResolution, noUncheckedIndexedAccess, paths, rootDir, skipDefaultLibCheck, skipLibCheck, sourceMap, strict, target)",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "34",
      "title": "Add root-level lint coverage for workspace config files",
      "description": "Root-level files (tsconfig.base.json, package.json, nx.json, etc.) are not covered by any project's nx lint target — only files inside apps/ and libs/ are linted. This means jsonc/sort-keys and other rules are not enforced on workspace config files during CI. Add a mechanism to lint root files, either via a dedicated root lint target, a workspace-level lint script, or by expanding an existing project's lintFilePatterns to include root JSON files.",
      "status": "completed",
      "notes": "Added root config files (package.json, tsconfig.base.json, nx.json) to the Next.js app's lintFilePatterns in project.json.template. This is the simplest Nx-idiomatic approach — the Next.js app is always present, so root files are linted whenever `nx run-many -t lint` runs. Added unit test and e2e smoke test verifying root patterns are included. All 311 tests pass. Build and lint pass.",
      "steps": [
        "Evaluate approach: (a) add a root-level project in nx.json with a lint target covering *.json at root, (b) update the root package.json 'lint' script to also run eslint on root files, or (c) add root JSON globs to the Next.js app's lintFilePatterns",
        "Implement the chosen approach in the relevant template(s)",
        "Update unit/e2e tests if new files or lint targets are added",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "35",
      "title": "E2E verification after root tsconfig and lint coverage fixes",
      "description": "After fixing tsconfig.base.json key ordering and adding root-level lint coverage, rebuild, pack, create a workspace, and verify: no jsonc/sort-keys IDE errors in tsconfig.base.json, root files are linted, all project lints pass, all builds succeed.",
      "status": "completed",
      "notes": "Full end-to-end verification passes on clean workspace. Initial lint run found 9 jsonc/sort-keys errors in tsconfig.base.json — the task 33 fix used simple alphabetical ordering but the @antfu/eslint-config jsonc/sort-keys rule uses a tsconfig-specific key order (target, jsx, lib, emitDecoratorMetadata, experimentalDecorators, baseUrl, rootDir, module, moduleResolution, paths, ..., strict, ..., declaration, importHelpers, ..., sourceMap, ..., skipDefaultLibCheck, skipLibCheck). Fixed the template to use the correct tsconfig compilerOptions key order. After fix: all 6 projects pass lint (0 errors), brand-ui:build passes, Next.js build passes (static pages generated), Storybook build passes. Root-level files (tsconfig.base.json, package.json, nx.json) are linted via the Next.js app's lintFilePatterns. All 311 automation tests pass.",
      "steps": [
        "Build automation: pnpm nx run automation:build",
        "Pack the dist: cd dist/libs/automation && pnpm pack --pack-destination /tmp/okam-test/",
        "Clean previous test: rm -rf /tmp/okam-test/test-starter",
        "Run create-nx-workspace with local tarball preset",
        "Run pnpm nx run-many -t lint — all projects must pass",
        "Verify tsconfig.base.json has no jsonc/sort-keys errors in IDE",
        "Run pnpm nx run brand-ui:build — must succeed",
        "Run pnpm nx run test-starter-nextjs:build — must succeed",
        "Run pnpm nx run storybook:build-storybook — must succeed",
        "If any step fails: fix templates, re-run automation:test, re-run this verification",
        "Clean up: rm -rf /tmp/okam-test/test-starter"
      ]
    },
    {
      "id": "36",
      "title": "Fix root package.json template jsonc/sort-keys ordering",
      "description": "The root package.json.template has jsonc/sort-keys violations: 'type' should come before 'version', 'scripts' should come after 'engines', 'packageManager' should come before 'engines'. Fix the key ordering in the template to match the expected sort-package-json convention.",
      "status": "completed",
      "notes": "Reordered top-level keys in root package.json.template to match jsonc/sort-package-json convention. Previous order: name, version, private, type, scripts, engines, packageManager. New order: name, type, version, private, packageManager, engines, scripts. This eliminates jsonc/sort-keys violations in generated workspaces. All 309 tests pass. Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/root/package.json.template: reorder top-level keys to match jsonc/sort-package-json convention (name, type, version, private, packageManager, engines, scripts, dependencies, devDependencies)",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "37",
      "title": "Fix layout.tsx metadata description mentioning Directus when excluded",
      "description": "The Next.js layout.tsx.template has a hardcoded metadata description 'powered by Next.js and Directus'. When includeDirectus is false, this is misleading. Make the description conditional via EJS: include 'and Directus' only when includeDirectus is true.",
      "status": "completed",
      "notes": "Added EJS conditional to layout.tsx.template metadata description: '<%= projectName %> — powered by Next.js<% if (includeDirectus) { %> and Directus<% } %>'. When includeDirectus is false, the description omits the Directus mention. All 311 tests pass. Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/apps/__appName__/src/app/layout.tsx.template: use EJS conditional in the metadata description — e.g. '<%= projectName %> — powered by Next.js<% if (includeDirectus) { %> and Directus<% } %>'",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "38",
      "title": "Make queries lib conditional on includeDirectus",
      "description": "The queries lib (libs/queries/) is built around graphql-request with a localhost:8055 Directus fallback URL, graphql-codegen for Directus schema introspection, and a codegen nx target. When includeDirectus is false, there is no GraphQL server to query — the entire lib becomes dead weight. Make the queries lib conditional: when includeDirectus is false, skip the queries lib directory, skip graphql/graphql-request/graphql-codegen deps, skip the queries path alias from tsconfig.base.json, and skip the codegen script from root package.json.",
      "status": "completed",
      "notes": "Made queries lib fully conditional on includeDirectus. When includeDirectus is false: (1) generator.ts skips queries lib generation (moved from unconditional libDirs to a separate conditional block), (2) graphql + graphql-request deps excluded from PINNED_VERSIONS, @graphql-codegen/cli excluded from PINNED_DEV_VERSIONS (both groups conditionally deleted alongside directus group), (3) tsconfig.base.json.template wraps @scope/queries and @scope/queries/server path aliases with EJS conditional, (4) root package.json.template wraps codegen script with EJS conditional, (5) type-check.yml CI workflow wraps the 'Run codegen' step with EJS conditional to prevent failure when codegen script doesn't exist. Added 7 unit tests: queries files absent, graphql/graphql-request deps absent, @graphql-codegen/cli devDep absent, queries path aliases absent, non-queries path aliases still present, codegen script absent. Updated existing unit test to remove queries from 'all library directories' assertion. Added ~16 e2e smoke tests: queries files absent (6 files), graphql deps absent, codegen devDep absent, tsconfig paths absent/present, codegen script absent, type-check workflow without codegen step. Removed queries from e2e json validity, scope consistency, and lib file existence lists. All 328 tests pass (87 unit + 239 e2e + 2 existing). Build and lint pass.",
      "steps": [
        "Update generator.ts: wrap queries lib generation in the same includeDirectus check — skip generateFilesIfExists for queries when includeDirectus is false",
        "Update generator.ts: move graphql and graphql-request from PINNED_VERSIONS to a new PINNED_VERSIONS.graphql group (or reuse existing), conditionally merge when includeDirectus is true",
        "Update generator.ts: move @graphql-codegen/cli from PINNED_DEV_VERSIONS to a conditional group, merge only when includeDirectus is true",
        "Update tsconfig.base.json.template: wrap @scope/queries and @scope/queries/server path aliases with EJS conditional on includeDirectus",
        "Update root package.json.template: wrap the 'codegen' script with EJS conditional on includeDirectus",
        "Update unit tests: in the 'when includeDirectus is false' describe block, assert queries lib files do NOT exist, graphql/graphql-request/graphql-codegen NOT in root deps, queries paths NOT in tsconfig.base.json",
        "Update e2e smoke tests: in the includeDirectus=false block, assert queries lib absent",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "39",
      "title": "Clean up csp.config.ts Directus fallback when includeDirectus is false",
      "description": "The csp.config.ts template uses localhost:8055 as the fallback for NEXT_PUBLIC_IMG_DOMAIN in img-src and connect-src directives. This is Directus-specific. When includeDirectus is false, the fallback should be a generic localhost or omitted entirely. Use EJS conditional to adjust the CSP fallback based on includeDirectus.",
      "status": "completed",
      "notes": "Added EJS conditional to csp.config.ts.template for the NEXT_PUBLIC_IMG_DOMAIN fallback in both img-src and connect-src directives. When includeDirectus is true, the fallback remains 'localhost:8055' (Directus default port). When includeDirectus is false, the fallback changes to 'localhost' (generic). All 328 tests pass. Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/apps/__appName__/csp.config.ts.template: use EJS conditional — when includeDirectus is true, keep localhost:8055 fallback; when false, use localhost:3000 or remove the Directus-specific fallback from img-src and connect-src",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "40",
      "title": "E2E verification after queries conditional and Directus cleanup",
      "description": "After making queries lib conditional on includeDirectus and cleaning up Directus references (layout description, csp.config fallback, root package.json sort-keys), rebuild, pack, create workspaces with and without Directus, and verify both configurations work correctly.",
      "status": "completed",
      "notes": "E2E verification revealed two template bugs in includeDirectus=false path: csp.config.ts and layout.tsx used truthy checks on the string 'false' (always truthy) instead of strict string comparison. Fixed both templates to use `includeDirectus === 'true'` consistent with other templates (next.config.js, package.json, tsconfig.base.json, type-check.yml). Added 6 new test assertions: WITH Directus — csp.config uses localhost:8055, layout mentions Directus; WITHOUT Directus — csp.config does NOT use localhost:8055, uses localhost instead, layout does NOT mention Directus, still mentions Next.js. All 334 tests pass (87 unit + 245 e2e + 2 other generators). Build and lint pass.",
      "steps": [
        "Build automation: pnpm nx run automation:build",
        "Pack the dist: cd dist/libs/automation && pnpm pack --pack-destination /tmp/okam-test/",
        "Test WITHOUT Directus: create-nx-workspace with --includeDirectus=false",
        "Verify: no libs/queries/ directory, no graphql deps in package.json, no codegen script, no Directus mention in layout.tsx description, csp.config has no localhost:8055, tsconfig.base.json has no queries path aliases",
        "Run pnpm nx run-many -t lint — all projects must pass",
        "Run pnpm nx run brand-ui:build && pnpm nx run <app>-nextjs:build && pnpm nx run storybook:build-storybook — all must succeed",
        "Test WITH Directus (default): create-nx-workspace without the flag",
        "Verify: libs/queries/ exists, graphql deps present, codegen script present, layout mentions Directus, csp has localhost:8055, tsconfig has queries paths",
        "Run pnpm nx run-many -t lint — all projects must pass",
        "Run all builds — must succeed (no regression)",
        "Clean up test workspaces"
      ]
    },
    {
      "id": "41",
      "title": "Make next.config.js image remotePatterns conditional on includeDirectus",
      "description": "The next.config.js template has an images.remotePatterns entry with port 8055 and pathname '/assets/**' — both Directus-specific (Directus serves uploaded assets at /assets/). When includeDirectus is false, this remote pattern is misleading and unnecessary. Use EJS conditional to either omit the Directus-specific pattern or use a generic fallback when includeDirectus is false.",
      "status": "completed",
      "notes": "Wrapped the images.remotePatterns block in next.config.js.template with EJS conditional `<% if (includeDirectus === 'true') { %>`. When includeDirectus is false, the entire images config (remotePatterns with port 8055 and pathname /assets/**) is omitted — no remote patterns needed without a CMS serving image assets. Added 1 unit test: verifies next.config.js does NOT contain remotePatterns, 8055, or /assets/** when includeDirectus is false. Added 1 e2e smoke test: same assertions in the includeDirectus=false suite. Enhanced existing e2e Directus-enabled test to also assert 8055 and /assets/** presence. All 336 tests pass (88 unit + 246 e2e + 2 other generators). Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/apps/__appName__/next.config.js.template: wrap the images.remotePatterns entry with EJS conditional on includeDirectus. When true: keep current pattern (port 8055, pathname /assets/**). When false: either omit remotePatterns entirely or use a generic pattern without the Directus-specific port and pathname",
        "Update unit tests: assert next.config.js does NOT contain port 8055 or /assets/** when includeDirectus is false",
        "Update e2e smoke tests: verify next.config.js image patterns differ between includeDirectus true/false",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "42",
      "title": "Add storybook test-runner.ts template with axe-playwright a11y testing",
      "description": "The storybook .storybook/ directory is missing a test-runner.ts configuration file. The reference project reference project (libs/storybook/.storybook/test-runner.ts) uses @storybook/test-runner with axe-playwright for automated accessibility testing: preVisit injects axe, postVisit collects a11y violations and writes them to JSON reports. The starter should include a generic version of this file, plus a test-storybook nx target in the storybook project.json, and the necessary dev dependencies (@storybook/test-runner, axe-playwright). Use process.env instead of a scoped env lib for the VERCEL_AUTOMATION_BYPASS_SECRET header.",
      "status": "completed",
      "notes": "Created test-runner.ts.template in libs/storybook/.storybook/ with @storybook/test-runner TestRunnerConfig: getHttpHeaders reads VERCEL_AUTOMATION_BYPASS_SECRET from process.env for Vercel protection bypass, preVisit injects axe, postVisit collects violations via getViolations and writes per-story JSON reports to reports/ directory. Added test-storybook target to storybook project.json using nx:run-commands executor with test-storybook --ci --url http://localhost:4200. Added @storybook/test-runner 0.24.2 and axe-playwright 2.2.2 to PINNED_DEV_VERSIONS.storybook in generator.ts. Added reports/__dot__gitkeep placeholder. Added 3 unit tests (test-storybook target, test-runner.ts content, reports/.gitkeep) and 2 dependency assertions. Added 4 e2e smoke tests (file existence for test-runner.ts and reports/.gitkeep, test-storybook target, test-runner.ts content) and 2 dependency assertions. All 343 tests pass (91 unit + 250 e2e + 2 existing). Build and lint pass.",
      "steps": [
        "Create libs/automation/src/generators/preset/files/libs/storybook/__dot__storybook/test-runner.ts.template: import TestRunnerConfig from @storybook/test-runner, import injectAxe/getViolations from axe-playwright, fs/path from node. getHttpHeaders reads VERCEL_AUTOMATION_BYPASS_SECRET from process.env for Vercel protection bypass. preVisit injects axe. postVisit collects violations and writes JSON reports to reports/ directory. Use fs.mkdirSync(reportsDir, { recursive: true }) to ensure reports dir exists",
        "Update libs/automation/src/generators/preset/files/libs/storybook/project.json.template: add a 'test-storybook' target using @nx/storybook:test executor (or a custom nx:run-commands target running 'test-storybook --url http://localhost:4200') with configDir option pointing to libs/storybook/.storybook",
        "Update generator.ts: add @storybook/test-runner and axe-playwright to PINNED_DEV_VERSIONS (check reference project for versions or use latest stable)",
        "Add libs/automation/src/generators/preset/files/libs/storybook/reports/__dot__gitkeep as an empty file so the reports directory is tracked in git",
        "Update unit tests: assert test-runner.ts exists in storybook .storybook directory, contains axe-playwright and @storybook/test-runner imports, contains getHttpHeaders/preVisit/postVisit",
        "Update e2e smoke tests: assert test-runner.ts exists, contains expected content, test-storybook target exists in storybook project.json",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "43",
      "title": "Add storybook a11y report helper scripts (merge-reports + axe-to-markdown)",
      "description": "The reference project reference project has two helper scripts in libs/storybook/ that process axe-playwright a11y results: (1) merge-reports.js — reads all per-story JSON audit files from reports/ directory and concatenates them into a single violations-report.json, (2) axe-to-markdown.js — converts the merged violations JSON into a formatted markdown report with summary table (description, rule ID, story ID, WCAG level, impact, count) and detailed section (element location, element source, fix suggestions). Both are used by the storybook-test.yml CI workflow. Add generic versions of both scripts as templates in the storybook lib scaffold.",
      "status": "completed",
      "notes": "Created merge-reports.js.template (CJS: reads individual JSON files from reports/ dir, attaches storyId from filename, merges into violations-report.json) and axe-to-markdown.js.template (ESM: reads merged JSON from argv[2], generates markdown with summary table (description, rule ID, story ID, WCAG info, impact, count) and detailed section (element target, source HTML, fix suggestions), WCAG tag formatting (wcag2a→WCAG 2 Level A, wcag412→WCAG 4.1.2), writes to argv[3] or stdout). Unit tests and e2e smoke tests updated. Build, lint, and all 349 tests pass.",
      "steps": [
        "Create libs/automation/src/generators/preset/files/libs/storybook/merge-reports.js.template: require fs/path, read all .json files from reports/ directory, concatenate arrays, write merged result to reports/violations-report.json",
        "Create libs/automation/src/generators/preset/files/libs/storybook/axe-to-markdown.js.template: ESM script (import fs from node:fs/promises), reads input JSON file from argv[2], generates markdown with summary table (description, axe rule ID, story ID, WCAG info, impact, count) and detailed section (element location, source HTML, fix suggestions), writes to argv[3] or stdout. Include WCAG tag formatting (wcag2a → 'WCAG 2 Level A', wcag412 → 'WCAG 4.1.2')",
        "Update unit tests: assert merge-reports.js and axe-to-markdown.js exist in storybook lib",
        "Update e2e smoke tests: assert both scripts exist with expected content",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "44",
      "title": "Add storybook-test.yml CI workflow for a11y testing on Vercel deployments",
      "description": "The reference project reference project has a storybook-test.yml GitHub Actions workflow that runs storybook accessibility tests against Vercel preview deployments. It triggers on deployment_status events, runs the test-storybook target against the deployed URL with Vercel bypass headers, merges individual a11y audit reports, converts to markdown, finds the associated PR, and posts the a11y report as a PR comment (upserts existing comment). The starter should include a generic version of this workflow. The workflow uses VERCEL_BYPASS_SECRET and GITHUB_TOKEN secrets. The Vercel environment name in the trigger condition should use the project name via EJS template variable.",
      "status": "completed",
      "notes": "Created storybook-test.yml.template CI workflow under files/root/__dot__github/workflows/. Workflow triggers on deployment_status events, filters by success state and EJS-templated environment name (<%= projectName %>-storybook). Steps: checkout, setup pnpm/node (using .nvmrc), install deps + Playwright, run test-storybook target with --ci --url against deployment URL and VERCEL_AUTOMATION_BYPASS_SECRET env (continue-on-error for graceful report collection), merge reports via merge-reports.js, convert to markdown via axe-to-markdown.js, find associated PR via actions/github-script (matches deployment SHA to open PRs), upsert PR comment with markdown report (uses <!-- storybook-a11y-report --> comment identifier), fail step if violations-report.json has entries. Added 1 unit test (storybook-test workflow content assertions) and updated includeDirectus=false CI workflow list. Added 2 e2e smoke tests (file existence + content correctness with deployment_status, test-storybook, merge-reports, axe-to-markdown, VERCEL_AUTOMATION_BYPASS_SECRET, storybook-a11y-report, project-name-storybook). Updated total file count from 84 to 85. All 353 tests pass (94 unit + 257 e2e + 2 existing). Build and lint pass.",
      "steps": [
        "Create libs/automation/src/generators/preset/files/root/__dot__github/workflows/storybook-test.yml.template: triggers on deployment_status, filters by success state and storybook environment name (use EJS for project name), steps: checkout, setup-node (.nvmrc), install pnpm, cache, install deps, install playwright (pnpm playwright install --with-deps), run storybook test-storybook target with --ci --url=${{ deployment_status.target_url }} and VERCEL_AUTOMATION_BYPASS_SECRET env, merge reports (pnpm exec node libs/storybook/merge-reports.js), convert to markdown (pnpm exec node libs/storybook/axe-to-markdown.js), find associated PR via actions/github-script, post/update PR comment with markdown report (comment identifier for upsert), fail if any non-empty audit reports exist",
        "Update unit tests: assert storybook-test.yml exists in .github/workflows, contains deployment_status trigger, contains test-storybook, contains merge-reports",
        "Update e2e smoke tests: assert workflow file exists with expected content",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "45",
      "title": "Add Directus deploy workflow and DigitalOcean App Platform specs (conditional on includeDirectus)",
      "description": "Following the reference deployment project pattern, add a deploy.yml workflow with 4 jobs via workflow_dispatch (create-staging, deploy-staging, create-production, deploy-production) plus automatic deploy-staging on push to main. Also add .do/ directory with App Platform spec YAML files for staging and production. Staging uses a dev DB (production: false), production uses production DBs. Both specs define: Directus service (Dockerfile, port 8055, health check), Postgres DB, Valkey/Redis, DO Spaces for file storage, Google OAuth. Secrets are injected via envsubst at deploy time. App names, bucket names, cluster names, and GitHub repo use EJS template variables (projectName, scope). Only generated when includeDirectus is true.",
      "status": "completed",
      "notes": "Created deploy.yml.template workflow with 4 jobs via workflow_dispatch (create-staging, deploy-staging, create-production, deploy-production) plus automatic deploy-staging on push to main. Each job uses GitHub environment protection rules (Directus - Staging / Directus - Production), envsubst for secret injection, and digitalocean/app_action/deploy@v2. Created .do/app-staging.yaml.template (staging: apps-s-1vcpu-1gb instance, production: false DBs, debug logging, EXTENSIONS_AUTO_RELOAD true, DO Spaces for file storage, Google OAuth) and .do/app.yaml.template (production: apps-s-1vcpu-2gb instance, production: true DBs, warn logging, EXTENSIONS_AUTO_RELOAD false). All EJS template variables (projectName, scope) resolve correctly for app names, bucket names, cluster names, and GitHub repo. Files placed in separate files/root-directus/ directory tree and conditionally generated in Section 4 of generator.ts (same includeDirectus guard as Directus app and queries lib). Added 5 unit tests (deploy workflow 4 jobs, staging spec config, production spec config, negative: deploy absent when no Directus, negative: .do/ specs absent when no Directus) and 7 e2e smoke tests (deploy workflow content, staging spec content, production spec content, file existence for all 3 new files, negative: all 3 absent when includeDirectus false). All 367 tests pass (99 unit + 266 e2e + 2 existing). Build and lint pass.",
      "steps": [
        "Create libs/automation/src/generators/preset/files/root/__dot__github/workflows/deploy.yml.template: workflow_dispatch with 4 choices (create-staging, deploy-staging, create-production, deploy-production). Also triggers on push to main. 4 jobs: create-staging (manual only, envsubst .do/app-staging.yaml, digitalocean/app_action/deploy with app_spec_location and project_id), deploy-staging (push to main OR manual, envsubst + deploy to existing app with app_name via EJS), create-production (manual only, envsubst .do/app.yaml, create app), deploy-production (manual only, envsubst + deploy to existing app). All jobs use GitHub environment protection rules (Directus - Staging / Directus - Production). Secrets: DIRECTUS_KEY/SECRET per env, SPACES_KEY/SECRET per env, AUTH_GOOGLE_CLIENT_ID/SECRET, DIGITALOCEAN_ACCESS_TOKEN. Use EJS for repo name and app names",
        "Create libs/automation/src/generators/preset/files/root/__dot__do/app-staging.yaml.template: App Platform spec for staging — app name via EJS (<%= projectName %>-staging), region tor1, Directus service (github repo via EJS, branch main, deploy_on_push false, dockerfile_path apps/directus/Dockerfile, port 8055, health check /server/health, instance_size apps-s-1vcpu-1gb), envs with ${VAR} placeholders for envsubst (DB, Redis, Spaces, OAuth), databases section with Postgres (production: false, cluster name via EJS) and Valkey/Redis, LOG_LEVEL debug",
        "Create libs/automation/src/generators/preset/files/root/__dot__do/app.yaml.template: App Platform spec for production — same structure but app name via EJS (<%= projectName %>-production), larger instance (apps-s-1vcpu-2gb), both DBs production: true, separate Spaces bucket name, LOG_LEVEL warn, EXTENSIONS_AUTO_RELOAD false",
        "Update generator.ts: only generate .do/ directory and deploy.yml workflow when includeDirectus is true (either via conditional generateFiles call or separate generateFilesIfExists block in the Directus section)",
        "Update unit tests: assert deploy.yml and .do/ specs exist when includeDirectus is true, absent when false. Verify app names contain project name, verify staging spec has production: false for Postgres",
        "Update e2e smoke tests: verify deploy workflow and .do/ specs presence/absence based on includeDirectus, verify content contains expected EJS-resolved project names",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "46",
      "title": "E2E verification after CI workflow additions",
      "description": "After adding storybook-test.yml, storybook a11y helper scripts, and deploy_digitalocean.yml workflows, rebuild, pack, create workspaces with and without Directus, and verify: all new files exist with correct content, deploy workflow is conditional on includeDirectus, all builds and lints pass.",
      "status": "completed",
      "notes": "Full E2E verification completed. Built, packed, and tested both WITH and WITHOUT Directus configurations via create-nx-workspace + nx generate. Fixed 2 lint issues in templates: (1) Providers.tsx.template import order — moved scope-prefixed brand-ui import before @tanstack/react-query to satisfy perfectionist/sort-imports; (2) test-runner.ts.template strict-boolean-expressions — replaced nullable string ternary with explicit null/empty check for VERCEL_AUTOMATION_BYPASS_SECRET. All 8 new files verified present with correct content (storybook-test.yml, deploy.yml, app-staging.yaml, app.yaml, merge-reports.js, axe-to-markdown.js, test-runner.ts, reports/.gitkeep). Deploy workflow conditional on includeDirectus confirmed. All lint (6 projects with, 5 without) and builds (brand-ui, Next.js, storybook) pass in both configurations.",
      "steps": [
        "Build automation: pnpm nx run automation:build",
        "Pack the dist: cd dist/libs/automation && pnpm pack --pack-destination /tmp/okam-test/",
        "Test WITH Directus (default): create-nx-workspace, verify: storybook-test.yml exists, deploy.yml exists, .do/app-staging.yaml exists, .do/app.yaml exists, merge-reports.js exists, axe-to-markdown.js exists, test-runner.ts exists, reports/.gitkeep exists, deploy.yml contains workflow_dispatch with 4 actions, app specs contain project name and correct DB production flags",
        "Run pnpm nx run-many -t lint — all projects must pass",
        "Run pnpm nx run brand-ui:build && pnpm nx run <app>-nextjs:build && pnpm nx run storybook:build-storybook — all must succeed",
        "Test WITHOUT Directus: create-nx-workspace with --includeDirectus=false, verify: storybook-test.yml exists (not Directus-dependent), deploy.yml does NOT exist, .do/ directory does NOT exist, all storybook files still present",
        "Run pnpm nx run-many -t lint — all projects must pass",
        "Run all builds — must succeed",
        "Clean up test workspaces"
      ]
    },
    {
      "id": "47",
      "title": "Fix Providers.tsx template import ordering for dynamic scope names",
      "description": "The Providers.tsx.template has @tanstack/react-query imported after <%= scope %>/i18n. When the scope resolves to a name that sorts after @tanstack alphabetically (e.g. @teststarter, @myorg), the perfectionist/sort-imports rule fails. The @tanstack/react-query import must come before any scope-prefixed imports since @tanstack sorts before most project scope names. Move the @tanstack/react-query import line to come immediately after @okam/stack-ui and before any <%= scope %>/* imports.",
      "status": "completed",
      "notes": "Reordered imports in Providers.tsx.template: @okam/stack-ui, @tanstack/react-query, then <%= scope %>/brand-ui and <%= scope %>/i18n. This ensures correctness regardless of the scope name chosen. Discovered during E2E verification with scope @teststarter which sorts after @tanstack. All 5 projects pass lint, all builds pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/apps/__appName__/src/app/Providers.tsx.template: move '@tanstack/react-query' import to come after '@okam/stack-ui' and before any '<%= scope %>/*' imports",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test — all tests must pass"
      ]
    },
    {
      "id": "48",
      "title": "Fix getTranslation template: unsafe return type from dynamic import",
      "description": "The getTranslation/index.ts.template used eslint-disable-next-line for ts/no-unsafe-return, but the disable comment only covers one line while prettier formats the arrow function across two lines. Replace the eslint-disable with a proper type assertion: `import(...) as Promise<ResourceKey>`. Also fix import ordering to satisfy perfectionist/sort-imports (type imports first, then value imports alphabetically).",
      "status": "completed",
      "notes": "Replaced eslint-disable-next-line with `as Promise<ResourceKey>` type assertion on the dynamic import(). Reordered imports: type ResourceKey, type SupportedLocale, then createInstance, resourcesToBackend, defaultNS/getOptions. Discovered during qampus initial commit when commitlint + lint-staged ran eslint.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/libs/i18n/src/lib/getTranslation/index.ts.template: replace eslint-disable-next-line with `as Promise<ResourceKey>` type assertion, fix import order",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test"
      ]
    },
    {
      "id": "49",
      "title": "Fix lint-staged: remove prettier from TS/TSX files (antfu stylistic conflict)",
      "description": "The generated lint-staged.config.js runs both eslint --fix and prettier --write on TS/TSX files. Since @antfu/eslint-config with stylistic: true is designed to replace prettier for JS/TS formatting, running prettier after eslint --fix undoes the stylistic fixes (quotes, operator-linebreak, arrow-parens, member-delimiter-style, antfu/if-newline). Remove prettier from TS/TSX files in lint-staged; keep it for json/md/css only.",
      "status": "completed",
      "notes": "Updated lint-staged.config.js template: TS/TSX files only run `eslint --no-warn-ignored --fix`, while `*.{js,json,md,css}` runs `prettier --write`. This resolves the 23 CI lint errors caused by prettier reformatting antfu-styled code.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/root/lint-staged.config.js: separate TS/TSX (eslint only) from other files (prettier only)",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test"
      ]
    },
    {
      "id": "50",
      "title": "Fix CI workflow templates: use .nvmrc for Node version",
      "description": "The lint.yml and type-check.yml CI workflow templates have hardcoded node-version: 22, but the generated project uses Node >=24.0.0 (with .nvmrc set to 24). Replace hardcoded node-version with node-version-file: .nvmrc so CI always matches the project's Node version.",
      "status": "completed",
      "notes": "Updated both lint.yml and type-check.yml templates to use `node-version-file: .nvmrc` instead of hardcoded `node-version: 22`. Also updated .nvmrc template to contain `24`.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/root/__dot__github/workflows/lint.yml: replace node-version: 22 with node-version-file: .nvmrc",
        "Update libs/automation/src/generators/preset/files/root/__dot__github/workflows/type-check.yml: same change",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test"
      ]
    },
    {
      "id": "51",
      "title": "Make env.ts template conditional on includeDirectus",
      "description": "The env.ts template unconditionally requires Directus-related environment variables (NEXT_SERVER_GRAPHQL_URL, API_SECRET, NEXT_PUBLIC_API_TOKEN, NEXT_PUBLIC_IMG_DOMAIN) even when includeDirectus is false. This causes build failures on Vercel since those env vars are not set. Wrap all Directus env var definitions and the zod import in EJS conditionals.",
      "status": "completed",
      "notes": "Verified: EJS conditionals already in place around all Directus env vars (z import, server vars, client vars, runtimeEnv) in env.ts.template. The includeDirectus variable is passed as String(includeDirectus) from generator.ts line 138. Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/apps/__appName__/src/lib/env.ts.template: wrap z import, server vars, client vars, and runtimeEnv vars in `<% if (includeDirectus === 'true') { -%>` conditionals",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test"
      ]
    },
    {
      "id": "52",
      "title": "Make Next.js standalone output conditional for Vercel compatibility",
      "description": "The next.config.js template has `output: 'standalone'` which produces a self-contained Node.js server for Docker deployments. However, Vercel requires its default serverless output format and returns 404 when standalone is set. Make the output conditional: use standalone for non-Vercel environments (Docker), use default (undefined) on Vercel. Vercel sets a VERCEL env var automatically during builds.",
      "status": "completed",
      "notes": "Changed `output: 'standalone'` to `output: process.env.VERCEL ? undefined : 'standalone'` in both the template and the qampus project.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/apps/__appName__/next.config.js.template: change output to `process.env.VERCEL ? undefined : 'standalone'`",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test"
      ]
    },
    {
      "id": "53",
      "title": "Add storybook and @storybook/* to dependabot ignore list",
      "description": "Storybook versions are managed by Nx (@nx/storybook expects specific Storybook versions) and should be updated together via nx migrate, not individually by dependabot. Add storybook and @storybook/* to the dependabot ignore list alongside nx and @nx/*.",
      "status": "completed",
      "notes": "Verified: storybook and @storybook/* were already present in the dependabot ignore list alongside nx and @nx/*. The template file at files/root/__dot__github/dependabot.yml has all four ignore entries. Build and lint pass.",
      "steps": [
        "Update libs/automation/src/generators/preset/files/root/__dot__github/dependabot.yml: add storybook and @storybook/* to ignore list",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test"
      ]
    },
    {
      "id": "54",
      "title": "Migrate Next.js app to Tailwind CSS v4 CSS-based configuration",
      "description": "The Next.js app template uses Tailwind v3-style tailwind.config.js (presets, content array, JSDoc type annotation) but the project installs Tailwind v4.1.18. Tailwind v4 uses CSS-based configuration with @import 'tailwindcss', @theme blocks, and @source directives instead of JS config files. Migrate the Next.js app to v4 format: create a globals.css entrypoint with @import 'tailwindcss', add @source directives for brand-ui and blocks libs, import globals.css in layout.tsx, and remove the v3 tailwind.config.js.",
      "status": "completed",
      "notes": "Created globals.css.template under files/apps/__appName__/src/app/ with @import 'tailwindcss' and @source directives for brand-ui and blocks libs (../../../../libs/brand-ui/src/**/*.{ts,tsx} and ../../../../libs/blocks/src/**/*.{ts,tsx}). Updated layout.tsx.template to import './globals.css'. Deleted the v3-style tailwind.config.js.template from the Next.js app (was using JS presets, content array, JSDoc type annotation). Updated generator.spec.ts: replaced tailwind.config.js content test with globals.css assertions (@import 'tailwindcss', @source, brand-ui, blocks), added negative test for v3 tailwind.config.js absence, added layout.tsx globals.css import test. Updated e2e-smoke.spec.ts: replaced tailwind.config.js in app file existence list with globals.css, added 3 content tests (layout imports globals.css, globals.css has v4 directives, v3 tailwind.config.js absent), added globals.css to includeDirectus=false app file list. All 373 tests pass (101 unit + 270 e2e + 2 existing). Build and lint pass.",
      "steps": [
        "Create libs/automation/src/generators/preset/files/apps/__appName__/src/app/globals.css.template: @import 'tailwindcss', @source directives for brand-ui and blocks content paths, @import of brand-ui theme CSS",
        "Update libs/automation/src/generators/preset/files/apps/__appName__/src/app/layout.tsx.template: add import './globals.css' at the top",
        "Delete libs/automation/src/generators/preset/files/apps/__appName__/tailwind.config.js.template",
        "Update unit tests and e2e smoke tests: remove tailwind.config.js assertions for app, add globals.css assertions (contains @import 'tailwindcss', @source directives)",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test"
      ]
    },
    {
      "id": "55",
      "title": "Migrate brand-ui to Tailwind CSS v4 CSS-based theme",
      "description": "The brand-ui lib template uses a Tailwind v3-style tailwind.config.js with theme.extend.colors and theme.extend.fontFamily. In Tailwind v4, theme customization is done via @theme blocks in CSS. Create a brand-ui theme.css file that defines brand color tokens and font families using @theme { }, export it so the Next.js app and storybook can import it. Remove the v3 tailwind.config.js from brand-ui. The tv()-based component themes in theme/index.tsx remain unchanged since tailwind-variants is CSS-framework-agnostic.",
      "status": "completed",
      "notes": "Created brand-ui/src/theme.css.template with Tailwind v4 @theme block containing --color-primary-* (50-950), --color-secondary-* (50-950), --font-sans, and --font-heading custom properties. Updated index.ts.template to import './theme.css' at the top. Deleted the v3-style tailwind.config.js.template (was using JS presets, theme.extend.colors, theme.extend.fontFamily). The tv()-based component themes in theme/index.tsx remain unchanged since tailwind-variants is CSS-framework-agnostic. Updated generator.spec.ts: added theme.css @theme block test, added import './theme.css' assertion to index.ts test, added v3 tailwind.config.js absence test (3 new tests → 103 total unit tests). Updated e2e-smoke.spec.ts: replaced tailwind.config.js in brand-ui file existence list with src/theme.css, added theme.css content test (@theme, --color-primary, --color-secondary, --font-sans, --font-heading), added v3 tailwind.config.js absence test, added import './theme.css' assertion (3 new tests → 272 total e2e tests). All 377 tests pass. Build and lint pass.",
      "steps": [
        "Create libs/automation/src/generators/preset/files/libs/brand-ui/src/theme.css.template: @theme block with --color-primary-* and --color-secondary-* tokens (matching the v3 color palette), --font-sans and --font-heading custom properties",
        "Update libs/automation/src/generators/preset/files/libs/brand-ui/src/index.ts.template: export the theme.css file (import './theme.css' or re-export path)",
        "Delete libs/automation/src/generators/preset/files/libs/brand-ui/tailwind.config.js.template",
        "Update unit tests and e2e smoke tests: remove brand-ui tailwind.config.js assertions, add theme.css assertions (contains @theme, --color-primary, --font-sans)",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test"
      ]
    },
    {
      "id": "56",
      "title": "Migrate root tailwind.preset.js to Tailwind v4 or remove it",
      "description": "The root tailwind.preset.js is a v3-style shared config used as a preset by the app and brand-ui tailwind.config.js files. In Tailwind v4, shared configuration is done via CSS imports rather than JS presets. Since brand-ui now owns the theme via theme.css (@theme block) and the app imports it, the root tailwind.preset.js is no longer needed. Remove it and update all references.",
      "status": "completed",
      "notes": "Deleted the v3-style tailwind.preset.js template from files/root/. No references in generator.ts (it was picked up automatically by the root generateFiles call). Removed unit test assertion (1 test removed from generator.spec.ts) and removed from both rootFiles arrays in e2e-smoke.spec.ts (default and includeDirectus=false suites). All 374 tests pass. Build and lint pass.",
      "steps": [
        "Delete libs/automation/src/generators/preset/files/root/tailwind.preset.js",
        "Update generator.ts if it references tailwind.preset.js in any file list or special handling",
        "Update unit tests and e2e smoke tests: remove tailwind.preset.js assertions from root config tests and file existence lists",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test"
      ]
    },
    {
      "id": "57",
      "title": "Update storybook preview to import Tailwind v4 CSS",
      "description": "The storybook preview.tsx wraps stories in ThemeProvider (for stack-ui component themes via tailwind-variants) but doesn't import any CSS. With Tailwind v4, storybook needs to import the CSS entrypoint so Tailwind utility classes are available in stories. Either import the app's globals.css or create a storybook-specific CSS file that imports tailwindcss and the brand-ui theme.css.",
      "status": "completed",
      "notes": "Created storybook.css.template in libs/storybook/.storybook/ with @import 'tailwindcss', @import of brand-ui theme.css (../../brand-ui/src/theme.css), and @source directives for brand-ui and blocks component source paths. Updated preview.tsx.template to import './storybook.css'. Added 2 unit tests: preview.tsx storybook.css import assertion, storybook.css content verification (@import tailwindcss, brand-ui/src/theme.css, @source directives for brand-ui and blocks). Added 3 e2e smoke tests: storybook.css file existence, storybook.css content verification, preview.tsx storybook.css import assertion. Updated total file count from 85 to 86. Added storybook.css to includeDirectus=false lib files list. All 378 tests pass (103 unit + 273 e2e + 2 existing). Build and lint pass.",
      "steps": [
        "Create libs/automation/src/generators/preset/files/libs/storybook/__dot__storybook/storybook.css.template (or similar): @import 'tailwindcss', @source directives for brand-ui and blocks, @import of brand-ui theme.css",
        "Update libs/automation/src/generators/preset/files/libs/storybook/__dot__storybook/preview.tsx.template: import './storybook.css' at the top",
        "Update unit tests and e2e smoke tests: add storybook CSS assertions",
        "VERIFY: pnpm nx run automation:build && pnpm nx run automation:lint && pnpm nx run automation:test"
      ]
    },
    {
      "id": "58",
      "title": "E2E verification of Tailwind v4 migration",
      "description": "After migrating all templates to Tailwind v4 CSS-based configuration, rebuild automation, create a test workspace, and verify: Tailwind utility classes work in the Next.js app (globals.css imported, @theme tokens available), brand-ui theme tokens resolve correctly, storybook renders with Tailwind styles, all lints and builds pass. Test both with and without Directus.",
      "status": "completed",
      "notes": "Full end-to-end verification passes for both WITH and WITHOUT Directus configurations. Built automation, packed to tarball, created workspaces via create-nx-workspace@22.3.3. Tailwind v4 migration verified: (1) No tailwind.config.js files exist anywhere in either workspace — v3 JS config fully removed. (2) globals.css present in Next.js app with @import 'tailwindcss' and @source directives for brand-ui and blocks. (3) brand-ui theme.css has @theme block with --color-primary-* (50-950), --color-secondary-* (50-950), --font-sans, --font-heading custom properties. (4) storybook.css has @import 'tailwindcss', @import of brand-ui theme.css, and @source directives. (5) layout.tsx imports globals.css. (6) 3 CSS files total per workspace (globals.css, theme.css, storybook.css). WITHOUT Directus: 5 projects lint (0 errors), brand-ui:build passes (CSS output 0.77 kB), Next.js build passes (static pages generated), Storybook build passes. No queries lib, no apps/directus — correct. WITH Directus: 6 projects lint (0 errors), all 3 builds pass, queries lib and directus app present. All 378 automation tests pass.",
      "steps": [
        "Build automation: pnpm nx run automation:build",
        "Pack the dist: cd dist/libs/automation && pnpm pack --pack-destination /tmp/okam-test/",
        "Create test workspace WITHOUT Directus: verify globals.css exists with @import 'tailwindcss', no tailwind.config.js files exist, brand-ui theme.css has @theme tokens",
        "Run pnpm nx run-many -t lint — all projects must pass",
        "Run pnpm nx build <app>-nextjs — must succeed, verify Tailwind classes in output",
        "Run pnpm nx build-storybook storybook — must succeed",
        "Create test workspace WITH Directus: same verifications",
        "Clean up test workspaces"
      ]
    }
  ]
}
