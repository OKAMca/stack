{
  "project": "@okam/react-utils extraction",
  "goal": "Extract React-dependent helpers into @okam/react-utils, keep @okam/core-lib server-safe, and provide non-breaking re-exports with deprecation.",
  "statuses": [
    "pending",
    "in_progress",
    "completed",
    "blocked"
  ],
  "config": {
    "agent": "claude",
    "context": "Nx monorepo with multiple publishable packages under libs/. Uses GitHub Actions for CI.",
    "verification": "pnpm install && pnpm nx run-many -t build lint --projects=tag:publishable"
  },
  "tasks": [
    {
      "id": "1",
      "title": "Create new @okam/react-utils library skeleton",
      "description": "Add a new publishable library under libs/stack/react-utils with Vite build, dts generation, and Nx project config.",
      "status": "completed",
      "steps": [
        "Add libs/stack/react-utils/package.json with name @okam/react-utils and React peer dependency",
        "Add libs/stack/react-utils/project.json with build target outputPath dist/libs/stack/react-utils",
        "Add libs/stack/react-utils/tsconfig.json + tsconfig.lib.json",
        "Add libs/stack/react-utils/vite.config.ts mirroring core-lib patterns (nxCopyAssetsPlugin, dts, isExternal)"
      ],
      "notes": "Created library skeleton with all configuration files. React peer dep and dequal dependency will be added in Task 2 when utilities are moved."
    },
    {
      "id": "2",
      "title": "Move React utilities into react-utils",
      "description": "Relocate createCtx/createCtxNullable and hooks into the new package and expose a clean public API.",
      "status": "completed",
      "steps": [
        "Move src/utils/createContext.tsx to libs/stack/react-utils/src/utils/createContext.tsx",
        "Move hooks: usePromise and useDeepCompareMemoize into libs/stack/react-utils/src/hooks",
        "Create libs/stack/react-utils/src/index.ts exporting createCtx, createCtxNullable, usePromise, useDeepCompareMemoize",
        "Move or update tests to live under libs/stack/react-utils/src/hooks/__tests__"
      ],
      "notes": "Copied createContext.tsx, usePromise.ts, useDeepCompareMemoize.ts and their tests to react-utils. Added dequal dependency and react peer dependency. Original files kept in core-lib for Task 3 deprecation re-exports."
    },
    {
      "id": "3",
      "title": "Keep non-breaking re-exports in @okam/core-lib",
      "description": "Re-export React utilities from @okam/core-lib with deprecation JSDoc so existing consumers keep working.",
      "status": "completed",
      "steps": [
        "Update libs/stack/core-lib/src/index.ts to re-export from @okam/react-utils",
        "Add @deprecated JSDoc on createCtx/createCtxNullable exports in core-lib",
        "Ensure server-safe exports remain in core-lib default entry"
      ],
      "notes": "Updated core-lib/src/index.ts to re-export createCtx and createCtxNullable from @okam/react-utils with @deprecated JSDoc. Removed the local createContext.tsx file from core-lib. Added @okam/react-utils as a dependency to core-lib package.json. All server-safe exports (ArrayUtils, Asserts, typeguards, etc.) remain unchanged."
    },
    {
      "id": "4",
      "title": "Adjust dependencies and exports",
      "description": "Shift React peer dependency to react-utils and keep core-lib server-safe for Node consumers.",
      "status": "completed",
      "steps": [
        "Remove react peer dependency from libs/stack/core-lib/package.json (or mark optional for transition)",
        "Add react peer dependency to libs/stack/react-utils/package.json",
        "Confirm exports field for core-lib includes react-server server-safe entry (keep existing fix)"
      ],
      "notes": "Made React peer dependency optional in core-lib via peerDependenciesMeta. Added react-server export condition and server.ts entry point for server-safe builds (excludes createCtx/createCtxNullable re-exports). Updated vite.config.ts for multiple entry points. react-utils already had correct React peer dependency."
    },
    {
      "id": "5",
      "title": "Update internal consumers to use @okam/react-utils",
      "description": "Migrate stack-ui and next-component to import React helpers from the new package.",
      "status": "completed",
      "steps": [
        "Update imports in libs/stack/stack-ui to use @okam/react-utils",
        "Update imports in libs/stack/next-component to use @okam/react-utils",
        "Run typecheck/build for affected packages"
      ],
      "notes": "Updated 7 provider files in stack-ui and 2 provider files in next-component to import createCtx/createCtxNullable from @okam/react-utils instead of @okam/core-lib. Added @okam/react-utils as dependency to both packages. Removed @okam/core-lib dependency from both packages (no longer needed). Theme provider in stack-ui keeps its local createCtxNullable implementation due to different behavior (returns null vs {} as A)."
    },
    {
      "id": "6",
      "title": "Build and release validation",
      "description": "Verify outputs, Next.js build, and document migration.",
      "status": "completed",
      "steps": [
        "Run npx nx build core-lib and npx nx build react-utils",
        "Verify @okam/core-lib server build avoids React imports",
        "Run npx nx build vanier-nextjs with workarounds removed",
        "Update README/CHANGELOG with migration note and deprecation"
      ],
      "notes": "All 13 publishable projects build and lint successfully. Verified server.mjs has no React imports while index.mjs includes React for deprecated createCtx/createCtxNullable re-exports. Added migration documentation to core-lib README.md and CHANGELOG.md. Created comprehensive README.md for react-utils with API documentation."
    },
    {
      "id": "7",
      "title": "Decouple core-lib from react-utils dependency",
      "description": "Avoid forcing React peer requirements on server-only consumers by revisiting how core-lib references react-utils.",
      "status": "completed",
      "steps": [
        "Decide whether core-lib should depend on react-utils or use optional/peer dependency + re-export guard",
        "If keeping re-exports, document that server-only environments should use the react-server condition",
        "Update core-lib package.json dependency strategy accordingly"
      ],
      "notes": "Changed @okam/react-utils from a direct dependency to an optional peer dependency in core-lib/package.json. This decouples the install-time dependency - server-only consumers who use the react-server export condition won't need to install react-utils. Consumers using the deprecated createCtx/createCtxNullable exports must explicitly install @okam/react-utils as a peer. Updated README.md with a note about peer dependency requirement. Updated CHANGELOG.md to reflect dependency change. Build output verified: server.mjs has no React imports, index.mjs includes the React-based helpers."
    },
    {
      "id": "8",
      "title": "Remove duplicated React hook sources from core-lib",
      "description": "Eliminate dead code and drift risk by deleting core-lib hook implementations after moving them to react-utils.",
      "status": "completed",
      "steps": [
        "Remove libs/stack/core-lib/src/hooks and related tests",
        "Ensure no exports reference the removed files",
        "Verify builds still pass"
      ],
      "notes": "Removed entire hooks directory from core-lib including: use-deep-compare-memoize.ts, use-promise.ts, index.ts, and their test files. Verified no exports in index.ts or server.ts referenced these files. Removed unused dequal dependency and react peer/dev dependencies from package.json since React is now handled transitively through @okam/react-utils. core-lib and react-utils build and lint successfully."
    },
    {
      "id": "9",
      "title": "Mark react-utils entry as client-only",
      "description": "Add an explicit client boundary to react-utils to prevent accidental use in server components.",
      "status": "completed",
      "steps": [
        "Add 'use client' to libs/stack/react-utils/src/index.ts or per-module as appropriate",
        "Confirm Next.js server builds fail fast if react-utils is imported in RSC"
      ],
      "notes": "Added 'use client' directive to all react-utils source files: index.ts (main entry point), use-deep-compare-memoize.ts, and use-promise.ts. createContext.tsx already had 'use client' directive. This ensures Next.js bundlers will properly detect these as client-only modules and fail fast if accidentally imported in React Server Components. All tests pass (6 tests), build and lint succeed."
    },
    {
      "id": "10",
      "title": "Add react-utils test target",
      "description": "Ensure react-utils tests are runnable via Nx.",
      "status": "completed",
      "steps": [
        "Add a test target in libs/stack/react-utils/project.json",
        "Verify tests execute via nx run react-utils:test"
      ],
      "notes": "Added test target using @nx/vitest:test executor to project.json. Added vitest test configuration to vite.config.ts with jsdom environment for React testing. Updated tests from deprecated @testing-library/react-hooks to @testing-library/react, replaced jest.fn() with vi.fn(), and migrated from waitForNextUpdate to waitFor API. All 6 tests pass via nx run react-utils:test."
    },
    {
      "id": "11",
      "title": "Add null-returning context helper to react-utils",
      "description": "Add a createCtxNullable variant that returns null when the context is missing, then adopt it in stack-ui Theme provider.",
      "status": "completed",
      "steps": [
        "Add a new helper export in @okam/react-utils (e.g., createCtxNullableOrNull)",
        "Update libs/stack/stack-ui/src/providers/Theme/index.tsx to use the new helper",
        "Document the new helper in react-utils README"
      ],
      "notes": "Added createCtxNullableStrict helper to @okam/react-utils that returns null when the context is missing (vs createCtxNullable which returns {} as A). Updated stack-ui Theme provider to import createCtxNullableStrict from @okam/react-utils, removing the local implementation. Documented the new helper in react-utils README with usage examples. All react-utils tests pass (6 tests), react-utils and core-lib build and lint successfully. Pre-existing lint/build errors in stack-ui and directus packages are unrelated to this change."
    },
    {
      "id": "12",
      "title": "Reinstall workspace dependencies and re-run lint",
      "description": "Ensure local node_modules matches lockfile so lint uses real types (not error types).",
      "status": "completed",
      "steps": [
        "Run npm ci (or the repo-standard install) at the workspace root",
        "Run npx nx run-many --all --target=lint --skip-nx-cache",
        "If errors remain, proceed with tasks 13-18"
      ],
      "notes": "Ran npm ci to sync node_modules and removed a stray pnpm-lock.yaml that was breaking the Nx project graph. After that, npx nx run-many --all --target=lint --skip-nx-cache passed for all 14 projects."
    },
    {
      "id": "13",
      "title": "Fix directus-query lint error",
      "description": "Resolve ts/no-unsafe-argument in query.ts by typing the GraphQL client usage correctly.",
      "status": "completed",
      "steps": [
        "Inspect libs/directus/directus-query/src/lib/query.ts and related request client types",
        "Ensure graphqlRequestClient is typed so document argument is safe",
        "Re-run directus-query:lint"
      ],
      "notes": "No code changes needed; the error disappeared after reinstalling dependencies and removing pnpm-lock.yaml."
    },
    {
      "id": "14",
      "title": "Fix directus-node lint errors",
      "description": "Resolve dependency-check and unsafe-call errors in directus-node.",
      "status": "completed",
      "steps": [
        "Remove unused dotenv dependency or wire it into codegen usage",
        "Fix unsafe-call errors in libs/directus/directus-node/src/lib/codegen.ts by typing inputs",
        "Re-run directus-node:lint"
      ],
      "notes": "No code changes needed; dependency-checks error was caused by Nx project graph failing due to pnpm-lock.yaml. After cleanup, directus-node lint passed."
    },
    {
      "id": "15",
      "title": "Fix stack-ui lint errors",
      "description": "Resolve unsafe-* errors in stack-ui components caused by unresolved or implicit any types.",
      "status": "completed",
      "steps": [
        "Identify modules with error-typed values (Accordion, Calendar, Carousel, Dialog, DateField, useLabelledOverlay)",
        "Add proper typings or type guards to eliminate unsafe assignments/calls",
        "Re-run stack-ui:lint"
      ],
      "notes": "No code changes needed; lint passed after dependency reinstall and pnpm-lock cleanup."
    },
    {
      "id": "16",
      "title": "Fix directus-block lint errors",
      "description": "Resolve unsafe assignments and redundant type constituent errors in directus-block.",
      "status": "completed",
      "steps": [
        "Fix BlockSerializer typing issues to avoid error-typed values",
        "Resolve TypedDocumentNode union type errors in getBlock.ts",
        "Re-run directus-block:lint"
      ],
      "notes": "No code changes needed; lint passed after dependency reinstall and pnpm-lock cleanup."
    },
    {
      "id": "17",
      "title": "Fix directus-next lint errors",
      "description": "Resolve unsafe assignments in getPageSettings.",
      "status": "completed",
      "steps": [
        "Add explicit typing or guards in libs/directus/directus-next/src/pageSettings/getPageSettings.ts",
        "Re-run directus-next:lint"
      ],
      "notes": "No code changes needed; lint passed after dependency reinstall and pnpm-lock cleanup."
    },
    {
      "id": "18",
      "title": "Fix demo app lint errors",
      "description": "Resolve unsafe-* errors in demo pages by typing API results and narrowing unknowns.",
      "status": "completed",
      "steps": [
        "Add explicit typings in demo Directus examples",
        "Re-run demo:lint"
      ],
      "notes": "No code changes needed; lint passed after dependency reinstall and pnpm-lock cleanup."
    },
    {
      "id": "19",
      "title": "Remove deprecated React re-exports from core-lib (breaking)",
      "description": "Make core-lib server-safe by default by removing createCtx/createCtxNullable re-exports and React deps.",
      "status": "completed",
      "steps": [
        "Remove createCtx/createCtxNullable re-exports from libs/stack/core-lib/src/index.ts",
        "Remove @okam/react-utils dependency and React peer/dev deps from libs/stack/core-lib/package.json",
        "Update core-lib README/CHANGELOG to note the breaking change",
        "Ensure all consumers import React helpers from @okam/react-utils"
      ],
      "notes": "Removed deprecated createCtx/createCtxNullable re-exports from core-lib index.ts. Removed @okam/react-utils peer dependency and peerDependenciesMeta from package.json. Removed react-server export condition and server.ts (no longer needed since core-lib is now server-safe by default). Updated directus-query to import createCtx from @okam/react-utils instead of @okam/core-lib. Updated README.md with breaking change documentation. Updated CHANGELOG.md with v2.0.0 breaking changes. All 13 publishable projects build and lint successfully."
    }
  ]
}
